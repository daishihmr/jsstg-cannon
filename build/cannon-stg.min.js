/*
 * Deep Striker v0.0.1
 * http://www.dev7.jp
 * 
 * The MIT License (MIT)
 * Copyright © 2014 daishi_hmr, dev7.jp
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */


var cannon={};!function(){var a=960,b=640;cannon.app=null,cannon.head=null,cannon.foot=null,cannon.gameScene=null,cannon.SC_W=a,cannon.SC_H=b,cannon.STAGE_COUNT=1,cannon.FIGHTER_RADIUS=a/96,cannon.FIGHTER_SPEED=a/100,cannon.SHOT_SPEED=a/32,cannon.HEAT_BY_SHOT=18,cannon.SHOT_POWER=3,cannon.SHOT_RADIUS=a/32,cannon.ZANKI_MAX=10,cannon.RANK_MAX=1e3,cannon.RANK_DOWN_AT_KILLED=-30,cannon.optionSettings={seVolume:.2,bgmVolume:.2},tm.display.Label.default.fontFamily="Orbitron",cannon.ASSETS={title:"images/title.png",fighter:"images/fighter.png",aura:"images/aura.png",shot:"images/shot.png",backfire:"images/backfire.png",explodeSmall:"images/exp.png",explode0:"images/exp_s.png",explode1:"images/exp_l.png",explodeBlue:"images/exp_blue.png",shockwave:"images/shockwave.png",spark:"images/spark.png",spark2:"images/spark2.png",boost:"images/boost.png",bullet:"images/bullet.png",scorerate:"images/scorerate.png",boss1_1:"images/boss1_1.png",boss1_2:"images/boss1_2.png",boss1_3:"images/boss1_3.png","sounds/extend":"sounds/extend.mp3","sounds/reload":"sounds/sen_ge_gun_otosu03.mp3","sounds/shot":"sounds/gun2.mp3","sounds/explode0":"sounds/sen_ge_taihou03.mp3","sounds/explode1":"sounds/sen_ge_bom14.mp3","sounds/pi":"sounds/se_maoudamashii_system26.mp3"},Array.range(0,15).forEach(function(a){cannon.ASSETS["enemy{0}".format(a)]="images/enemy{0}.png".format(a)}),Math.PHI=1.61803399}(),cannon.onAssetsLoaded=function(a){return function(){return["enemy0","enemy1","enemy2","enemy3","enemy4","enemy5","enemy6","enemy7","enemy8","enemy9","enemy10","enemy11","enemy12","enemy13","enemy14","boss1_1","boss1_2","boss1_3"].forEach(function(a){var b=tm.asset.Manager.get(a),c=tm.graphics.Canvas().resize(2*b.width,2*b.height);c.drawTexture(b,.5*b.width,.5*b.height,b.width,b.height),c.stackBlur(50);var d=tm.graphics.Canvas().resize(b.width,b.height);d.drawTexture(b,0,0),d.strokeStyle="transparent";for(var e=0;e<d.height;e+=3)d.clear(0,e,d.width,1);for(var f=tm.graphics.Bitmap(b.width,b.height),g=b.getBitmap(),e=0,h=b.height;h>e;e++)for(var i=0,j=b.width;j>i;i++){var k=g.getPixelXY(i,e);f.setPixel32XY(i,e,k[0],.5*k[1],.5*k[2],k[3])}var l=tm.graphics.Canvas().resize(b.width,b.height);l.drawBitmap(f,0,0);var m=tm.graphics.Canvas().resize(2*b.width*3,2*b.height);m.globalCompositeOperation="lighter",m.globalAlpha=.12;for(var n=0;10>n;n++)m.drawImage(c.canvas,0*b.width,0);m.globalCompositeOperation="source-over",m.globalAlpha=1,m.drawImage(d.canvas,.5*b.width,.5*b.height,b.width,b.height),m.globalCompositeOperation="lighter",m.globalAlpha=.12;for(var n=0;15>n;n++)m.drawImage(c.canvas,2*b.width,0);m.globalCompositeOperation="lighter",m.globalAlpha=1;for(var n=0;3>n;n++)m.drawImage(d.canvas,2.5*b.width,.5*b.height,b.width,b.height);m.globalCompositeOperation="lighter",m.globalAlpha=.12;for(var n=0;10>n;n++)m.drawImage(c.canvas,4*b.width,0);m.globalCompositeOperation="source-over",m.globalAlpha=1,m.drawImage(l.canvas,4.5*b.width,.5*b.height,b.width,b.height),tm.asset.Manager.set(a,m)}),a()}},tm.define("cannon.Application",{superClass:"tm.display.CanvasApp",init:function(a){this.superInit(a),this.fps=60,this.resize(cannon.SC_W,cannon.SC_H).fitWindow().replaceScene(cannon.LoadingScene({width:cannon.SC_W,height:cannon.SC_H,assets:cannon.ASSETS,nextScene:cannon.onAssetsLoaded(cannon.TitleScene)})),this.keyboard.element.addEventListener("keydown",function(a){(37<=a.keyCode&&a.keyCode<=40||32===a.keyCode)&&a.preventDefault()},!1),this.webgl=WebGLise(this)}}),tm.define("cannon.GameData",{superClass:"tm.event.EventDispatcher",_score:0,_zanki:0,_rank:0,init:function(){this.superInit()},initializeValues:function(){this.score=0,this.zanki=3,this.rank=0}}),cannon.GameData.prototype.accessor("score",{get:function(){return this._score},set:function(a){var b=this._score;this._score=a,5e4>b&&a>=5e4&&cannon.playSe("shot"),this.flare("updatescore")}}),cannon.GameData.prototype.accessor("zanki",{get:function(){return this._zanki},set:function(a){this._zanki=a,this.flare("updatezanki")}}),cannon.GameData.prototype.accessor("rank",{get:function(){return this._rank},set:function(a){this._rank=Math.clamp(a,0,cannon.RANK_MAX),bulletml.Walker.globalScope.$rank=.001*this._rank,this.flare("updaterank")}}),function(){cannon.playSe=function(a){tm.asset.Manager.get("sounds/"+a).clone().setVolume(cannon.optionSettings.seVolume).play()},cannon.bgm=null,cannon.playBgm=function(a,b){cannon.bgm&&cannon.bgm.stop(),cannon.bgm=tm.asset.Manager.get(a).clone(),cannon.bgm.setVolume(cannon.optionSettings.bgmVolume).setLoop(!0).play(),b&&(cannon.bgm.source.loopStart=b[0],cannon.bgm.source.loopEnd=b[1])}}(),tm.define("cannon.EndingScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:{label:{type:"tm.display.Label",init:"ending",x:.5*cannon.SC_W,y:.5*cannon.SC_H}}})}}),function(){var a=null,b=[0,0,0,0,0,0],c=0,d=0,e=!0;tm.define("cannon.GameScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),cannon.gameScene=this,this.fromJSON({children:{backgroundLayer:{type:"tm.display.CanvasElement"},playerLayer:{type:"tm.display.CanvasElement",children:{player:{type:"cannon.Fighter",scene:this,controllable:!1}}},terrainLayer:{type:"tm.display.CanvasElement"},enemyLayer:{type:"tm.display.CanvasElement"},bulletLayer:{type:"tm.display.CanvasElement"},uiLayer:{type:"tm.display.CanvasElement",children:{scoreLabel:{type:"cannon.ScoreLabel",x:5,y:5},rankLabel:{type:"cannon.RankLabel",x:5,y:40},zankiLabel:{type:"cannon.ZankiLabel",x:37,y:cannon.SC_H-32-5},gameoverLabel:{type:"tm.display.Label",init:["Game Over",96],fillStyle:"hsl(0, 100%, 50%)",x:.5*cannon.SC_W,y:.5*cannon.SC_H,alpha:0,visible:!1},warningLabel:{type:"tm.display.CanvasElement",alpha:0,visible:!1,children:[{type:"tm.display.Label",init:["CAUTION!!",96],fillStyle:"hsl(0, 80%, 80%)",x:.5*cannon.SC_W,y:.5*cannon.SC_H+10,shadowColor:"white",shadowBlur:15,blendMode:"lighter",onenterframe:function(a){this.alpha=.6+.4*Math.sin(.2*a.app.frame)}}]},bossBattleTimeLabel:{type:"cannon.CountDownLabel",init:6e4,x:cannon.SC_W-5,y:5,visible:!1}}}}});var b=this;a=cannon.GameData(),a.on("updatescore",function(){b.uiLayer.scoreLabel.score=this.score}),a.on("updaterank",function(){b.uiLayer.rankLabel.rank=this.rank}),a.on("updatezanki",function(){b.uiLayer.zankiLabel.zanki=this.zanki}),a.initializeValues(),"localhost"===location.hostname&&(cannon.gameData=a),this.stageIndex=0,this.player=this.playerLayer.player,this.player.on("killed",function(){var c=tm.app.Tweener(b.webglParams).set({quake:6}).to({quake:0},600).on("finish",function(){b.off("enterframe",d)}),d=function(a){c.update(a.app)};return b.on("enterframe",d),a.zanki-=1,a.zanki<=0?void b.gameover():(a.rank+=cannon.RANK_DOWN_AT_KILLED,b.tweener.clear().wait(500).call(function(){b.launchPlayer()}),void(e=!1))}),this.bulletmlConfig={target:this.player,createNewBullet:function(a,b){cannon.BulletMLBullet(a,b).addChildTo(this.bulletLayer)}.bind(this)},this.on("enter",function(a){this.webglParams=a.app.webgl.params.addChildTo(this),this.stageStart()}),this.on("enterframe",function(b){b.app.frame%300===0&&window.parent.theiwoge&&window.parent.theiwoge(a.score)}),console.log(window.parent)},stageStart:function(){this.uiLayer.scoreLabel.clearAnimation(),this.uiLayer.rankLabel.clearAnimation(),this.uiLayer.bossBattleTimeLabel.visible=!1,this.backgroundLayer.removeChildren(),this.terrainLayer.removeChildren(),this.enemyLayer.removeChildren(),this.bulletLayer.removeChildren(),this.webglParams.quake=0,this.webglParams.labelAreaHeight=0,this.webglParams.strength=0,this.webglParams.lightRadius=0,cannon.Enemy.ACTIVES.clear(),cannon.Bullet.ACTIVES.clear(),cannon.Shot.ACTIVES.clear(),b=[0,0,0,0,0,0],c=0,d=0,e=!0,this.mt=new MersenneTwister(1e3+this.stageIndex);var a=cannon.STAGE_DATA[this.stageIndex];cannon.Background(a.background).addChildTo(this.backgroundLayer),cannon.Terrain(a.terrain).addChildTo(this.terrainLayer),this.scrollSpeed=a.scrollSpeed,this.stageStep=a.stageStep.clone(),this.waitCount=0,this.launchPlayer(),cannon.playBgm(a.bgm,a.bgmLoopRange)},stageClear:function(){var f=this;this.uiLayer.scoreLabel.animation=!1,this.uiLayer.rankLabel.animation=!1;var g=cannon.ResultScene({gameData:a,comboCount:b,killRatio:d/c,bossBattleTime:this.uiLayer.bossBattleTimeLabel.time,perfectBonus:d/c>=1?1e4:0,noMissBonus:e?1e4:0});g.on("finish",function(){f.uiLayer.scoreLabel.animation=!0,f.uiLayer.rankLabel.animation=!0,this.app.popScene(),f.stageIndex<cannon.STAGE_COUNT?f.stageStart():f.app.replaceScene(cannon.EndingScene(a.score))}),this.app.pushScene(g)},update:function(a){for(var b=this,c=this.terrainLayer.children,d=this.backgroundLayer.children,e=0,f=c.length;f>e;e++)c[e].scroll+=this.scrollSpeed;for(var e=0,f=d.length;f>e;e++)d[e].scroll+=.5*this.scrollSpeed;for(var e=0,f=cannon.Enemy.ACTIVES.length;f>e;e++){var g=cannon.Enemy.ACTIVES[e];g.isGround&&(g.x-=b.scrollSpeed)}this.step(),this.testCollision(),a.keyboard.getKeyDown("space")&&this.app.pushScene(cannon.PauseScene())},step:function(){if(this.waitCount-=1,!(this.waitCount>0)){var a=this.stageStep.shift();if(void 0!==a)switch(a.type){case"wait":this.waitCount=a.value;break;case"enemy":this.launchEnemy(a);break;case"boss":this.launchBoss(a)}}},launchEnemy:function(a){var b=cannon.Zako(cannon.ENEMY_DATA[a.enemyType]).addChildTo(this.enemyLayer);switch(a.motionType){case"route":b.setRoute(a.data);break;case"sine":b.setSineWaveMotion(a.data);break;case"horizontal":b.setHorizontalMotion(a.data);break;case"homing":b.setHomingMotion(a.data,this.player);break;case"run":b.setRunMotion(a.data);break;case"jump":b.setJumpMotion(a.data)}var e=a.attack;if(e){var f=e.match("{(\\d)}");f&&(e=e.replace(f[0],this.mt.nextInt(~~f[1])));var g=cannon.ATTACK_DATA[e];g&&b.startAttack(g,this.bulletmlConfig)}var h=this;b.shotBack&&b.on("destroy",function(){cannon.AimBullet({target:h.player,x:this.x,y:this.y,speed:1}).addChildTo(h.bulletLayer)}),c+=1,b.on("destroy",function(){d+=1})},launchBoss:function(a){var b=this,e=this.webglParams,f=this.uiLayer.warningLabel;f.visible=!0,f.alpha=0;var g=tm.using(a.boss)(),h=this.uiLayer.bossBattleTimeLabel;h.on("timeup",function(){g.muteki=!0,g.tweener.clear().to({x:1.5*cannon.SC_W},3e3,"easeInQuad").call(function(){g.remove()})}),this.tweener.clear().call(function(){e.tweener.clear().to({labelAreaHeight:60},700,"easeOutBack")}).wait(700).call(function(){f.tweener.clear().to({alpha:1},1e3)}).wait(3e3).call(function(){f.tweener.clear().to({alpha:0},1e3)}).wait(1e3).call(function(){e.tweener.clear().to({labelAreaHeight:0},700,"easeInBack")}).call(function(){h.x+=100,h.visible=!0,h.tweener.clear().by({x:-100},500,"easeOutBack").call(function(){h.start()}),g.addChildTo(b.enemyLayer)});var i=Array.range(0,12).map(function(){return cannon.LightLine()});g.on("destroy",function(){b.player.muteki=!0,h.stop(),i.forEach(function(a){a.setPosition(this.x,this.y).addChildTo(b.enemyLayer)}.bind(this)),b.webglParams.centerOffset=[this.x,this.y],b.webglParams.tweener.clear().wait(3e3).call(function(){b.webglParams.quake=2}).to({strength:20,lightRadius:1200},3e3,"easeOutQuad").to({quake:0},1500).call(function(){this.remove()}.bind(this))}),g.on("removed",function(){i.forEach(function(a){a.remove()}),b.player.muteki=!0,b.webglParams.quake=0,b.webglParams.strength=0,b.webglParams.lightRadius=0,b.stageClear()}),c+=1,g.on("destroy",function(){d+=1})},testCollision:function(){var c,d,e,f=this.player,g=this.terrainLayer.children;e=cannon.Enemy.ACTIVES.clone(),d=cannon.Shot.ACTIVES.clone();for(var h=0,i=d.length;i>h;h++)for(var j=d[h],k=0,l=e.length;l>k;k++){var m=e[k];if(j.isHitElement(m)){if(!m.damage(cannon.SHOT_POWER)){j.damage();break}var n=Math.min(j.killCount,5);b[n]+=1;var o=[1,2,4,8,16,32][n]*m.score;a.score+=o,j.killEnemy(m,this.uiLayer),a.rank+=n}}e=cannon.Enemy.ACTIVES.clone();for(var h=0,p=e.length;p>h;h++){var m=e[h];if(m.hasTerrainCollider){var q=null,r=0;if(g.some(function(a,b){return r=b,null!==(q=a.getHitLine(m))})){var s=tm.event.Event("hitterrain");s.line=q,s.terrain=g[r],s.gameScene=this,m.fire(s)}}}c=cannon.Bullet.ACTIVES.clone();for(var h=0,p=c.length;p>h;h++){var t=c[h];g.some(function(a){return null!==a.getHitLine(t)})&&t.damage()}d=cannon.Shot.ACTIVES.clone();for(var h=0,p=d.length;p>h;h++){var j=d[h];g.some(function(a){return null!==a.getHitLine(j)})&&j.damage()}if(f.parent){e=cannon.Enemy.ACTIVES.clone();for(var h=0,p=e.length;p>h;h++){var m=e[h];if(f.isHitElement(m)&&f.damage())break}c=cannon.Bullet.ACTIVES.clone();for(var h=0,p=c.length;p>h;h++){var t=c[h];if(f.isHitElement(t)&&(t.damage(),f.damage()))break}g.some(function(a){return null!==a.getHitLine(f)})&&f.damage()}},launchPlayer:function(){var a=this.player;a.parent||a.addChildTo(this.playerLayer),a.muteki=!1,a.controllable=!1,a.muteki=!0,a.direction=1,a.x=cannon.SC_W*-.2,a.y=.5*cannon.SC_H,a.boostOn(),a.tweener.clear().to({x:.2*cannon.SC_W},2e3,"easeOutBack").call(function(){a.controllable=!0}).wait(2e3).call(function(){a.muteki=!1,a.boostOff()})},gameover:function(){var a=this.uiLayer.gameoverLabel;a.tweener.clear().set({alpha:0,visible:!0}).fadeIn(500).wait(3e3).set({alpha:0,visible:!1}).call(function(){cannon.app.replaceScene(cannon.TitleScene())})}}),cannon.GameScene.createLoadingScene=function(a){return cannon.LoadingScene({width:cannon.SC_W,height:cannon.SC_H,assets:cannon.STAGE_DATA[a].assets,nextScene:function(){var b=cannon.GameScene(a);return b}})}}(),tm.define("cannon.LoadingScene",{superClass:"tm.ui.LoadingScene",init:function(){this.superInit.apply(this,arguments),this.stage.bg.canvas.setFillStyle("black").fillRect(0,0,cannon.SC_W,cannon.SC_H);for(var a=0;10>a;a++)this._createHiyoko(this.param).setPosition(Math.rand(0,cannon.SC_W),Math.rand(0,cannon.SC_H)).addChildTo(this.stage.piyoLayer)},_createHiyoko:function(a){var b=tm.display.Shape(84,84);b.x=tm.util.Random.randint(0,a.width),b.y=tm.util.Random.randint(0,a.height),b.canvas.setColorStyle("white",tm.graphics.RadialGradient(42,42,0,42,42,32).addColorStopList([{offset:0,color:"hsla(200,100%, 80%, 1.0)"},{offset:.5,color:"hsla(200,100%, 80%, 1.0)"},{offset:1,color:"hsla(200,100%, 70%, 0.0)"}]).toStyle()).fillCircle(42,42,32),b.canvas.setColorStyle("white","black").fillCircle(27,27,2),b.canvas.setColorStyle("white","brown").fillRect(40,70,4,15).fillTriangle(0,40,11,35,11,45),b.dir=tm.geom.Vector2.random(0,360,4);var c=tm.geom.Rect(0,0,a.width,a.height);return c.padding(42),b.update=function(){this.position.add(this.dir),this.x<c.left?(this.x=c.left,this.dir.x*=-1):this.x>c.right&&(this.x=c.right,this.dir.x*=-1),this.y<c.top?(this.y=c.top,this.dir.y*=-1):this.y>c.bottom&&(this.y=c.bottom,this.dir.y*=-1),this.dir.x<0?(this.rotation-=7,this.scaleX=1):(this.rotation+=7,this.scaleX=-1)},b}}),tm.define("cannon.MenuDialog",{superClass:"tm.ui.MenuDialog",init:function(a,b,c,d){this.superInit({title:a,menu:b,menuDesctiptions:c,defaultIndex:d||0,showExit:!0,width:cannon.SC_W,height:cannon.SC_H,backgroundColor:"hsla(200, 80%, 5%, 0.6)",boxColor:"hsla(200, 80%, 20%, 0.9)",cursorColor:"hsla(200, 80%, 30%, 0.9)",okKey:"z",cancelKey:"x"}),this.on("enter",function(){cannon.playSe("extend")}),this.on("preselected",function(){cannon.playSe("extend")}),this.on("selected",function(){cannon.playSe("shot")}),this.on("canceled",function(){cannon.playSe("extend")})}}),tm.define("cannon.NameEntryScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:{label:{type:"tm.display.Label",init:"name entry",x:.5*cannon.SC_W,y:.5*cannon.SC_H}}})}}),tm.define("cannon.PauseScene",{superClass:"tm.app.Scene",init:function(){this.superInit()},update:function(a){var b=a.keyboard;b.getKeyDown("space")&&this.app.popScene()}}),tm.define("cannon.ResultScene",{superClass:"tm.app.Scene",init:function(a){this.superInit(),this.bossBattleTime=a.bossBattleTime,this.perfectBonus=a.perfectBonus,this.noMissBonus=a.noMissBonus,this.score=a.gameData.score;var b=this;this.fromJSON({children:{bg:{type:"tm.display.RectangleShape",init:[cannon.SC_W,cannon.SC_H,{fillStyle:"black",strokeStyle:"transparent"}],originX:0,originY:0},scoreLabel:{type:"tm.display.Label",init:["",28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.85*cannon.SC_H,onenterframe:function(){this.text=""+Math.floor(b.score)},alpha:0},prompt:{type:"tm.display.Label",init:["press [z] key",30],align:"center",baseline:"middle",x:.5*cannon.SC_W,y:.95*cannon.SC_H,alpha:0},labels:{type:"tm.display.CanvasElement",alpha:0,children:{title:{type:"tm.display.Label",init:["result",40],align:"center",baseline:"middle",x:.5*cannon.SC_W,y:.1*cannon.SC_H},combo1:{type:"tm.display.Label",init:["combo x1",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.2*cannon.SC_H},combo2:{type:"tm.display.Label",init:["combo x2",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.25*cannon.SC_H},combo3:{type:"tm.display.Label",init:["combo x4",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.3*cannon.SC_H},combo4:{type:"tm.display.Label",init:["combo x8",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.35*cannon.SC_H},combo5:{type:"tm.display.Label",init:["combo x16",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.4*cannon.SC_H},combo6:{type:"tm.display.Label",init:["combo x32",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.45*cannon.SC_H},bonus:{type:"tm.display.Label",init:["bonus",30],align:"center",baseline:"middle",x:.5*cannon.SC_W,y:.55*cannon.SC_H},bossBattleTime:{type:"tm.display.Label",init:["boss battle time",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.65*cannon.SC_H},perfect:{type:"tm.display.Label",init:["100% destroy",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.7*cannon.SC_H},noMiss:{type:"tm.display.Label",init:["no miss",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.75*cannon.SC_H},score:{type:"tm.display.Label",init:["score",28],align:"left",baseline:"middle",x:.3*cannon.SC_W,y:.85*cannon.SC_H}}},values:{type:"tm.display.CanvasElement",children:{combo1:{type:"tm.display.Label",init:[""+a.comboCount[0],28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.2*cannon.SC_H,visible:!1},combo2:{type:"tm.display.Label",init:[""+a.comboCount[1],28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.25*cannon.SC_H,visible:!1},combo3:{type:"tm.display.Label",init:[""+a.comboCount[2],28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.3*cannon.SC_H,visible:!1},combo4:{type:"tm.display.Label",init:[""+a.comboCount[3],28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.35*cannon.SC_H,visible:!1},combo5:{type:"tm.display.Label",init:[""+a.comboCount[4],28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.4*cannon.SC_H,visible:!1},combo6:{type:"tm.display.Label",init:[""+a.comboCount[5],28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.45*cannon.SC_H,visible:!1},bossBattleTime:{type:"tm.display.Label",init:["",28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.65*cannon.SC_H,onenterframe:function(){this.text=""+Math.floor(b.bossBattleTime)},visible:!1},perfect:{type:"tm.display.Label",init:["",28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.7*cannon.SC_H,onenterframe:function(){this.text=""+Math.floor(b.perfectBonus)},visible:!1},noMiss:{type:"tm.display.Label",init:["",28],align:"right",fontFamily:"ShareTechMono",baseline:"middle",x:.7*cannon.SC_W,y:.75*cannon.SC_H,onenterframe:function(){this.text=""+Math.floor(b.noMissBonus)},visible:!1}}}}}),this.skip=function(a){(a.app.keyboard.getKeyDown("z")||a.app.keyboard.getKeyDown("x"))&&this.tweener.skip()},this.on("enterframe",function(){a.gameData.score=this.score}),this.on("enter",function(){this.show()}.bind(this))},show:function(){var a=this.values.children;this.scoreLabel.tweener.clear().fadeIn(500),this.labels.tweener.clear().fadeIn(500);var b=this.tweener.clear();b.wait(500),a.forEach(function(a){b.wait(300).call(function(){cannon.playSe("pi"),a.visible=!0})}),b.call(function(){this.startCalcScore()}.bind(this)),this.on("enterframe",this.skip)},startCalcScore:function(){var a=this,b=function(a){a.app.frame%2&&cannon.playSe("pi")};this.tweener.clear().wait(1e3).call(function(){a.on("enterframe",b)}),this.bossBattleTime>0&&this.tweener.to({bossBattleTime:0,score:this.score+this.bossBattleTime},1e3),this.perfectBonus>0&&this.tweener.to({perfectBonus:0,score:this.score+this.bossBattleTime+this.perfectBonus},1e3),this.noMissBonus>0&&this.tweener.to({noMissBonus:0,score:this.score+this.bossBattleTime+this.perfectBonus+this.noMissBonus},1e3),this.tweener.call(function(){this.off("enterframe",this.skip),a.off("enterframe",b),this.prompt.tweener.fadeIn(500),this.on("enterframe",function(a){a.app.keyboard.getKeyDown("z")&&this.flare("finish")})}.bind(this))}}),tm.define("cannon.TitleScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.setInteractive(!0);var a=0;this.on("enterframe",function(){a+=1}),this.fromJSON({children:{bgColor:{type:"tm.display.RectangleShape",init:[cannon.SC_W,cannon.SC_H,{fillStyle:"black",strokeStyle:"transparent"}],originX:0,originY:0},bg:{type:"tm.display.Sprite",init:["title",cannon.SC_H,cannon.SC_H],x:.5*cannon.SC_W,y:.5*cannon.SC_H,alpha:.2,onenterframe:function(){this.alpha=.6+.4*Math.sin(Math.PI*-.5+.01*a)}},pre:{type:"tm.display.Label",init:["JavaScript STG Festival 2014",36],x:.5*cannon.SC_W,y:.25*cannon.SC_H-80,shadowColor:"white",shadowBlur:15,blendMode:"lighter"},title:{type:"tm.display.Label",init:["Deep Striker",96],x:.5*cannon.SC_W,y:.25*cannon.SC_H,fillStyle:tm.graphics.LinearGradient(.5*-cannon.SC_W,-250,.5*cannon.SC_W,250).addColorStopList([{offset:.3,color:"hsl(200, 90%, 50%)"},{offset:.5,color:"hsl(200, 80%,100%)"},{offset:.7,color:"hsl(200, 90%, 50%)"}]).toStyle(),shadowColor:"white",shadowBlur:15,blendMode:"lighter"},credit:{type:"tm.display.Label",init:["Copyright © 2014 daishi_hmr",24],x:.5*cannon.SC_W,y:.9*cannon.SC_H},prompt:{type:"tm.display.Label",init:["press [Z] key",36],fillStyle:"hsl(200, 90%, 70%)",x:.5*cannon.SC_W,y:.8*cannon.SC_H,shadowColor:"white",shadowBlur:5,blendMode:"lighter",onenterframe:function(){this.alpha=.6+.4*Math.sin(.2*a)}}}}),this.on("pointingend",function(){this.openMenu()})},update:function(a){(a.keyboard.getKeyUp("z")||a.keyboard.getKeyUp("x")||a.keyboard.getKeyUp("space"))&&this.openMenu()},openMenu:function(){var a=this;cannon.app.pushScene(cannon.MenuDialog("MENU",["game start","option"],["ゲームスタート","設定"]).on("closed",function(b){switch(b.value){case"game start":a.startGame()}}))},startGame:function(){cannon.app.replaceScene(cannon.GameScene.createLoadingScene(0))}}),tm.define("cannon.Background",{superClass:"tm.display.CanvasElement",init:function(a){this.superInit();var b=this;Array.range(0,3).forEach(function(c){var d=tm.display.Sprite(a.texture,cannon.SC_H,cannon.SC_H).setOrigin(0,0).setPosition(cannon.SC_H*c,0).addChildTo(b);d.index=c}),this.scroll=0},update:function(){var a=this.scroll,b=cannon.SC_H;this.children.forEach(function(c){c.x=-a%b+b*c.index})}}),tm.define("cannon.Boss",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.parts=[],this.on("added",function(){var a=this;this.parts.forEach(function(b){b.parentPart=a,b.addChildTo(a.parent)})}),this.muteki=!1,this.on("removed",function(){this.parts.forEach(function(a){a.parent&&a.remove()})})},setCore:function(a){var b=this;this.core=a,this.core.on("destroy",function(){b.flare("destroy"),this.damage=function(){}}),this.core.destroy=function(){}}}),cannon.Boss.prototype.accessor("muteki",{get:function(){return this._muteki},set:function(a){this.parts.forEach(function(b){b.muteki=a?9999:0}),this._muteki=a}}),tm.define("cannon.BossPart",{superClass:"cannon.Enemy",init:function(a){this.superInit(),this.fromJSON({boundingType:"circle",radius:a.radius,score:a.score,hp:a.hp,expType:a.expType,offsetX:a.x,offsetY:a.y,scaleX:a.scaleX,scaleY:a.scaleY,delay:a.delay,parentHistory:[],basicFrameIndex:0,children:{body:{type:"tm.display.Sprite",init:[a.texture,2*a.size,2*a.size],frameIndex:0}}});var b=this;this.body.on("enterframe",function(a){this.setFrameIndex(b.muteki>0?a.app.frame%2:b.basicFrameIndex)}),this.on("dying",function(){this.basicFrameIndex=2,this.body.setFrameIndex(this.basicFrameIndex)}),this.on("added",function(){this.setPosition(this.parentPart.x+this.offsetX,this.parentPart.y+this.offsetY);for(var a=0;a<this.delay;a++)this.parentHistory.push(this.parentPart.getFinalMatrix())}),this.on("enterframe",function(){this.parentHistory.push(this.parentPart.getFinalMatrix());var a=this.parentHistory.shift(),b=a.multiplyVector2({x:this.offsetX,y:this.offsetY});this.x=b.x,this.y=b.y,this.rotation=Math.atan2(a.m10,a.m00)*Math.RAD_TO_DEG})},destroy:function(a){switch(this.expType){case 0:cannon.Explode(this.x,this.y).addChildTo(this.parent);break;case 1:cannon.LargeExplode(this.x,this.y).addChildTo(this.parent)}if(this.remove(),a){var b=tm.event.Event("destroyPart");b.part=this,this.parentPart.fire(b)}}}),tm.define("cannon.Boss1",{superClass:"cannon.Boss",init:function(){this.superInit(),this.fromJSON({x:1.2*cannon.SC_W,y:.5*cannon.SC_H,rotation:-180,parts:cannon.BOSS1_DATA.parts.map(function(a){return cannon.BossPart(a)})}),this.phase1=[this.motion1,this.motion2,this.motion2,this.motion3],this.phase2=[this.motion4,this.motion5,this.motion6],this.currentPhase=this.phase1,this.motions=[this.motion0],this.next();this.setCore(this.parts[4]),this.on("destroyPart",function(a){this.motionDamage(a.part)}),this.on("destroy",function(){this.fireOff(),this.tweener.clear();var a=this.core;this.parts.forEach(function(b){b!==a&&b.parent&&b.destroy(!1)})})},next:function(){0===this.motions.length&&Array.prototype.push.apply(this.motions,this.currentPhase),this.motions.shift().call(this)},attack0:function(){var a=this,b=this.getRoot();[0,2].forEach(function(c){var d=a.parts[c];d.hp>0&&[{x:20,y:-20,d:0},{x:20,y:10,d:10},{x:20,y:40,d:20}].forEach(function(a){var c=d.localToGlobal(a);cannon.DirectionalBullet({x:c.x,y:c.y,direction:d.rotation+a.d*(d.scaleY>0?1:-1),speed:2}).addChildTo(b.bulletLayer)})})},attack1:function(){var a=this,b=this.getRoot();[1,3].forEach(function(c){var d=a.parts[c];if(d.hp>0){var e=d.localToGlobal({x:0,y:0});cannon.AimBullet({color:2,target:b.player,x:e.x,y:e.y,direction:0,speed:3}).addChildTo(b.bulletLayer),cannon.AimBullet({color:2,target:b.player,x:e.x,y:e.y,direction:-10,speed:3}).addChildTo(b.bulletLayer),cannon.AimBullet({color:2,target:b.player,x:e.x,y:e.y,direction:10,speed:3}).addChildTo(b.bulletLayer)}})},attack2:function(){for(var a=this.getRoot(),b=0;360>b;b+=10)cannon.AimBullet({color:2,target:a.player,x:this.x,y:this.y,direction:b,speed:3}).addChildTo(a.bulletLayer)},fireOn:function(){var a=this.getRoot();this.autoFire=this.autoFire||function(b){b.app.frame%5===0&&(cannon.DirectionalBullet({x:this.x,y:this.y,direction:this.rotation-5,speed:2}).addChildTo(a.bulletLayer),cannon.DirectionalBullet({x:this.x,y:this.y,direction:this.rotation,speed:2}).addChildTo(a.bulletLayer),cannon.DirectionalBullet({x:this.x,y:this.y,direction:this.rotation+5,speed:2}).addChildTo(a.bulletLayer))},this.on("enterframe",this.autoFire)},fireOff:function(){this.off("enterframe",this.autoFire)},motionDamage:function(a){if(null==this.parts[0].parent&&null==this.parts[2].parent&&(this.motions.eraseAll(this.motion1),this.motions.eraseAll(this.motion3),this.phase1.eraseAll(this.motion1),this.phase1.eraseAll(this.motion3)),null==this.parts[1].parent&&null==this.parts[3].parent&&(this.motions.eraseAll(this.motion2),this.phase1.eraseAll(this.motion2)),null!=this.core.parent){null==this.parts[0].parent&&null==this.parts[1].parent&&null==this.parts[2].parent&&null==this.parts[3].parent&&(this.currentPhase=this.phase2,this.motions.push(this.motion0));var b=this.rotation+(a.offsetY<0?-30:30);this.tweener.clear().to({x:Math.clamp(this.x+100,.05*cannon.SC_W,.95*cannon.SC_W),rotation:b},500,"easeOutQuad").call(function(){this.muteki=!0}.bind(this)).wait(500).call(function(){this.muteki=!1,this.next()}.bind(this))}},motion0:function(){this.muteki=!0,this.tweener.clear().to({x:.75*cannon.SC_W,y:.5*cannon.SC_H,rotation:180},2500,"easeInOutBack").call(function(){this.muteki=!1,this.next()}.bind(this))},motion1:function(){this.tweener.clear().to({x:.7*cannon.SC_W,y:.3*cannon.SC_H,rotation:160},1600,"easeInOutBack").call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).to({x:.7*cannon.SC_W,y:.7*cannon.SC_H,rotation:200},1600,"easeInOutBack").call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).to({x:.75*cannon.SC_W,y:.35*cannon.SC_H,rotation:170},1600,"easeInOutBack").call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).to({x:.75*cannon.SC_W,y:.65*cannon.SC_H,rotation:190},1600,"easeInOutBack").call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.next()}.bind(this))},motion2:function(){this.tweener.clear().to({x:.9*cannon.SC_W,y:.5*cannon.SC_H,rotation:180},1600,"easeInOutBack").call(function(){this.attack1()}.bind(this)).wait(100).call(function(){this.attack1()}.bind(this)).wait(100).call(function(){this.attack1()}.bind(this)).wait(100).to({x:.8*cannon.SC_W,y:.25*cannon.SC_H,rotation:150},1600,"easeInOutBack").call(function(){this.attack1()}.bind(this)).wait(100).call(function(){this.attack1()}.bind(this)).wait(100).call(function(){this.attack1()}.bind(this)).wait(100).to({x:.8*cannon.SC_W,y:.75*cannon.SC_H,rotation:210},1600,"easeInOutBack").call(function(){this.attack1()}.bind(this)).wait(100).call(function(){this.attack1()}.bind(this)).wait(100).call(function(){this.attack1()}.bind(this)).wait(100).call(function(){this.next()}.bind(this))},motion3:function(){this.tweener.clear().to({x:.65*cannon.SC_W,y:.2*cannon.SC_H,rotation:150},1600,"easeInOutBack").call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).to({x:.65*cannon.SC_W,y:.8*cannon.SC_H,rotation:210},1600,"easeInOutBack").call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).to({x:.8*cannon.SC_W,y:.4*cannon.SC_H,rotation:175},1600,"easeInOutBack").call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).to({x:.8*cannon.SC_W,y:.6*cannon.SC_H,rotation:185},1600,"easeInOutBack").call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.attack0()}.bind(this)).wait(300).call(function(){this.next()}.bind(this))},motion4:function(){this.fireOn(),this.tweener.clear().by({rotation:720},3e3,"easeInOutBack").call(function(){this.fireOff()}.bind(this)).call(function(){this.next()}.bind(this))},motion5:function(){this.tweener.clear().wait(30).call(function(){this.attack2()}.bind(this)).wait(30).call(function(){this.attack2()}.bind(this)).wait(30).call(function(){this.attack2()}.bind(this)).call(function(){this.next()}.bind(this))},motion6:function(){this.fireOn(),this.tweener.clear().by({rotation:-720},3e3,"easeInOutBack").call(function(){this.fireOff()}.bind(this)).call(function(){this.next()}.bind(this))}}),tm.define("BossExplode",{superClass:"tm.display.CanvasElement",init:function(){this.superInit()}}),tm.define("FallLine",{superClass:"tm.display.CanvasElement"}),tm.define("cannon.Bullet",{superClass:"tm.display.Sprite",init:function(a){this.superInit("bullet",16,16),this.fromJSON({scaleX:2,scaleY:.5,frameIndex:a||0,boundingType:"circle",radius:8}),this.on("added",function(){cannon.Bullet.ACTIVES.push(this)
}),this.on("removed",function(){cannon.Bullet.ACTIVES.erase(this)})},update:function(){(this.x+this.radius<0||cannon.SC_W<=this.x-this.radius||this.y+this.radius<0||cannon.SC_H<=this.y-this.radius)&&this.remove()},damage:function(){this.remove()}}),tm.define("cannon.AimBullet",{superClass:"cannon.Bullet",init:function(a){this.superInit(a.color),this.fromJSON({x:a.x,y:a.y});var b=bulletml.Walker.globalScope.$rank,c=3*a.speed*(1+2*Math.sqrt(b)),d=tm.geom.Vector2.sub(a.target,a);d.setAngle(d.toAngle()*Math.RAD_TO_DEG+(a.direction||0)),d.normalize().mul(c),this.on("enterframe",function(){this.position.add(d)}),this.rotation=d.toAngle()*Math.RAD_TO_DEG}}),tm.define("cannon.DirectionalBullet",{superClass:"cannon.Bullet",init:function(a){this.superInit(a.color),this.fromJSON({x:a.x,y:a.y,rotation:a.direction});var b=bulletml.Walker.globalScope.$rank,c=3*a.speed*(1+2*Math.sqrt(b)),d=tm.geom.Vector2().setAngle(a.direction).mul(c);this.on("enterframe",function(){this.position.add(d)})}}),tm.define("cannon.BulletMLBullet",{superClass:"cannon.Bullet",init:function(a,b){this.superInit(b.color),this.fromJSON({x:a.x,y:a.y}),a.onVanish=function(){this.parent&&this.remove()}.bind(this);var c=0,d=0;this.on("enterframe",function(){a.update(),this.setPosition(a.x,a.y),this.rotation=Math.atan2(this.y-d,this.x-c)*Math.RAD_TO_DEG,c=this.x,d=this.y})}}),cannon.Bullet.ACTIVES=[],cannon.Bullet.eraseAll=function(){for(var a=cannon.Bullet.ACTIVES.clone(),b=0,c=a.length;c>b;b++)a[b].remove()},tm.define("cannon.CountDownLabel",{superClass:"tm.display.Label",time:0,init:function(a){this.superInit("1:00.00",35),this.setAlign("right").setBaseline("top").setFillStyle("white").setFontFamily("ShareTechMono"),this.counting=!1,this.time=a},start:function(a){this.time=a||6e4,this.last=Date.now(),this.counting=!0},stop:function(){this.counting=!1},update:function(){if(this.counting){var a=Date.now();this.time-=a-this.last,this.last=a,this.time<0&&(this.time=0,this.counting=!1,this.flare("timeup"))}var b=Math.floor(this.time/6e4),c=(this.time-6e4*b)/1e3,d=Math.floor(100*c)/100,e=""+d;1===e.split(".").length?e+=".00":1===e.split(".")[1].length&&(e+="0"),4===e.length&&(e="0"+e),this.text="{0}:{1}".format(b,e)}}),tm.define("cannon.EffectSprite",{superClass:"tm.display.Sprite",init:function(a,b,c,d,e){this.superInit(a,b,c),this.setFrameIndex(0).setBlendMode("lighter"),this.f=0,this.finalIndex=d,this.frameIncr=e},update:function(){this.f+=this.frameIncr,this.frameIndex=~~this.f,this.f>=this.finalIndex&&this.remove()}}),tm.define("cannon.SmallExplode",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("explodeSmall",64,64,64,1),this.setRotation(Math.rand(0,360)).setScale(2).setPosition(a,b)}}),tm.define("cannon.Explode",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("explode0",128,128,64,1),this.setRotation(Math.rand(0,360)).setScale(2).setPosition(a,b)},onadded:function(){cannon.playSe("explode0")}}),tm.define("cannon.LargeExplode",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("explode1",128,128,64,1),this.setRotation(Math.rand(0,360)).setScale(3.5).setPosition(a,b)},onadded:function(){cannon.playSe("explode1")}}),tm.define("cannon.PlayerExplode",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("explodeBlue",64,64,64,1),this.setRotation(Math.rand(0,360)).setScale(2.5).setPosition(a,b)},onadded:function(){cannon.playSe("explode1")}}),tm.define("cannon.ShockWave",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("shockwave",64,64,64,2),this.setPosition(a,b)}}),tm.define("cannon.Spark",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("spark",64,64,64,2),this.setPosition(a,b)}}),tm.define("cannon.Spark2",{superClass:"cannon.EffectSprite",init:function(a,b,c){this.superInit("spark2",128,128,25,c||1.5),this.setOrigin(.9,.5).setPosition(a,b)}}),tm.define("cannon.Boost",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("boost",128,128,25,1),this.setPosition(a,b)}}),tm.define("cannon.Enemy",{superClass:"tm.display.CanvasElement",score:0,hp:0,muteki:0,entered:!1,age:0,shotBack:!1,init:function(){this.superInit(),this.on("added",function(){cannon.Enemy.ACTIVES.push(this),this.entered=!1,this.age=0}),this.on("removed",function(){cannon.Enemy.ACTIVES.erase(this)})},update:function(){this.inScreen()&&(this.entered=!0),!this.inScreen()&&this.entered&&this.remove(),this.muteki=Math.max(0,this.muteki-1),this.age+=1},inScreen:function(){return 0<=this.x+this.size&&this.x-this.size<cannon.SC_W&&0<=this.y+this.size&&this.size-this.size<cannon.SC_H},damage:function(a){if(this.muteki<=0){if(this.hp-=a,this.muteki=10,this.hp<=0)return this.flare("destroy"),this.destroy(!0),!0;this.hp<=cannon.SHOT_POWER&&this.flare("dying")}return!1},destroy:function(){},startAttack:function(a,b){b=(b||{}).$safe(bulletml.runner.DEFAULT_CONFIG);var c=a.createRunner(b);c.x=this.x,c.y=this.y;var d=function(){c.x=this.x,c.y=this.y,c.update(),this.setPosition(c.x,c.y)};d.isDanmaku=!0,this.on("enterframe",d)},stopAttack:function(){if(this.hasEventListener("enterframe"))for(var a=this._listeners.enterframe.clone(),b=0;b<a.length;b++)a[b].isDanmaku&&this.off("enterframe",a[b])}}),cannon.Enemy.ACTIVES=[],cannon.Enemy.eraseAll=function(){},tm.define("cannon.Fighter",{superClass:"tm.display.CanvasElement",scene:null,controllable:!1,muteki:!1,direction:1,init:function(){this.superInit(),this.fromJSON({children:{backfire2:{type:"tm.display.Sprite",init:"backfire",originX:1,blendMode:"lighter"},backfire:{type:"tm.display.Sprite",init:["aura",80,120],frameIndex:0,x:-50,y:0,blendMode:"lighter"},body:{type:"tm.display.Sprite",init:["fighter",128,64],frameIndex:2,scaleX:.75,scaleY:.75}}}),this.setBoundingType("circle"),this.radius=cannon.FIGHTER_RADIUS,this.beforeX=this.x=cannon.SC_W*-.5,this.beforeY=this.y=.5*cannon.SC_H,this.roll=0,this.heat=0,this.gunPosition=0,this.backfire.update=function(a){this.visible&&(this.setFrameIndex(a.frame%4),this.scaleX=[.8,1,1.2,1][a.frame%4])},this.backfire2.update=function(a){this.visible&&(this.scaleX=[.8,1,1.2,1][a.frame%4])}},update:function(a){if(this.scaleX=this.direction,this.controllable){var b=a.keyboard,c=b.getKeyDirection();this.position.add(c.mul(cannon.FIGHTER_SPEED)),this.x=Math.clamp(this.x,32,cannon.SC_W-32),this.y=Math.clamp(this.y,16,cannon.SC_H-16),c.y<0?this.roll-=.1:0<c.y?this.roll+=.1:(this.roll*=.9,-.01<this.roll&&this.roll<.01&&(this.roll=0));var d=b.getKeyDown("z"),e=b.getKeyDown("x");(d||e)&&(this.direction=e?1:-1,this.heat<=0&&(cannon.Shot(this.direction).setPosition(this.x+60*this.direction,this.y+7).addChildTo(this.parent),this.heat=cannon.HEAT_BY_SHOT,this.gunPosition=2),this.scaleX!==this.direction&&cannon.Boost(this.x,this.y).setPosition(-100,0).setScale(2,2).addChildTo(this)),this.heat>0&&(this.heat-=1,this.gunPosition=Math.max(this.gunPosition-.2,0),this.heat<=0&&cannon.playSe("reload"))}else this.roll*=.9,-.01<this.roll&&this.roll<.01&&(this.roll=0);this.roll=Math.clamp(this.roll,-2,2),this.body.setFrameIndex(3*~~(2+this.roll+.5)+~~(this.gunPosition+.5))},boostOn:function(){this.backfire.alpha=this.backfire2.alpha=1,this.backfire.visible=this.backfire2.visible=!0,this.backfire.tweener.clear(),this.backfire2.tweener.clear()},boostOff:function(){this.backfire.tweener.clear().fadeOut(300),this.backfire2.tweener.clear().fadeOut(300).call(function(){this.backfire.visible=this.backfire2.visible=!1}.bind(this))},damage:function(){return this.controllable&&!this.muteki?(this.parent&&cannon.PlayerExplode(this.x,this.y).addChildTo(this.parent),this.remove(),this.flare("killed"),!0):!1}}),tm.define("cannon.LightLine",{superClass:"tm.display.Shape",init:function(){var a=Math.rand(10,30);this.superInit(200,a),this.canvas.setFillStyle(tm.graphics.RadialGradient(0,.5*a,0,0,.5*a,200).addColorStopList([{offset:0,color:"hsla(160, 100%, 95%, 0.0)"},{offset:Math.randf(.1,.3),color:"hsla(160, 100%, 95%, 1.0)"},{offset:1,color:"hsla(160, 100%, 95%, 0.0)"}]).toStyle()).fillTriangle(0,.5*a,200,0,200,a),this.setOrigin(0,.5).setRotation(Math.rand(0,360)).setBlendMode("lighter").setAlpha(0).setScale(Math.randf(.1,.2)),this.on("added",function(){this.tweener.wait(Math.rand(200,1e3)).by({alpha:1,scaleX:2.6,scaleY:2.6,rotation:Math.rand(-180,180)},5e3,"easeOutQuart")})}}),tm.define("cannon.RankLabel",{superClass:"tm.display.Label",_rank:0,showing:0,animation:!0,init:function(){this.superInit("0",25),this.setAlign("left").setBaseline("top").setFillStyle("white").setFontFamily("ShareTechMono")},clearAnimation:function(){this.showing=this._rank,this.tweener.clear()},update:function(a){for(var b=""+Math.floor(this.showing),c=0,d=4-b.length;d>c;c++)b="0"+b;var e="rank:"+b;this.text!==e&&(this.text=e),this.alpha=.6+.4*Math.sin(.1*a.frame)}}),cannon.RankLabel.prototype.accessor("rank",{get:function(){return this._rank},set:function(a){this._rank=a,this.animation?this.tweener.clear().to({showing:this._rank},500):this.showing=this._rank}}),tm.define("cannon.ScoreLabel",{superClass:"tm.display.Label",_score:0,showing:0,animation:!0,init:function(){this.superInit("0",35),this.setAlign("left").setBaseline("top").setFillStyle("white").setFontFamily("ShareTechMono")},clearAnimation:function(){this.showing=this._score,this.tweener.clear()},update:function(a){for(var b=""+Math.floor(this.showing),c=0,d=9-b.length;d>c;c++)b="0"+b;var e="score:"+b;this.text!==e&&(this.text=e),this.alpha=.6+.4*Math.sin(.1*a.frame)}}),cannon.ScoreLabel.prototype.accessor("score",{get:function(){return this._score},set:function(a){this._score=a,this.animation?this.tweener.clear().to({showing:this._score},500):this.showing=this._score}}),tm.define("cannon.ScoreRate",{superClass:"tm.display.Sprite",init:function(a,b,c){this.superInit("scorerate",64,64),this.setScale(2).setPosition(b,c).setFrameIndex(a),this.tweener.to({y:c-120,alpha:0},1e3).call(function(){this.remove()}.bind(this))}}),tm.define("cannon.Shot",{superClass:"tm.display.Sprite",direction:1,killCount:0,init:function(a){this.superInit("shot"),this.direction=a,this.setScale(5*this.direction,5),this.boundingType="circle",this.radius=3*cannon.SHOT_RADIUS,this.vsTerrainRadius=.25*cannon.SHOT_RADIUS;var b=this;this.on("added",function(){cannon.playSe("shot"),cannon.ShockWave(this.x,this.y).setScale(1*this.direction,4).on("enterframe",function(){this.x+=2*-b.direction}).addChildTo(this.parent),cannon.Spark(this.x,this.y).setRotation(Math.rand(0,360)).setScale(2*this.direction,2).addChildTo(this.parent),cannon.Spark2(this.x,this.y,3).setScale(2*this.direction,1).addChildTo(this.parent)});var c=0;this.on("enterframe",function(){c>6&&(this.radius=cannon.SHOT_RADIUS,this.off("enterframe",arguments.callee)),c+=1}),this.on("added",function(){cannon.Shot.ACTIVES.push(this)}),this.on("removed",function(){cannon.Shot.ACTIVES.erase(this)})},update:function(a){this.scaleY=5+a.frame%2,this.x+=cannon.SHOT_SPEED*this.direction,(this.x<0-this.radius||cannon.SC_W+this.radius<this.x)&&this.remove()},killEnemy:function(a,b){this.killCount>0&&cannon.ScoreRate(Math.min(this.killCount-1,4),a.x,a.y).addChildTo(b),this.killCount+=1},damage:function(){cannon.ShockWave(this.x,this.y).setScale(1*this.direction,4).addChildTo(this.parent),cannon.ShockWave(this.x,this.y).setScale(.75*this.direction,3).addChildTo(this.parent),cannon.Spark2(this.x,this.y).setScale(3*this.direction,3).addChildTo(this.parent),this.remove()}}),cannon.Shot.ACTIVES=[],tm.define("cannon.Terrain",{superClass:"tm.display.CanvasElement",init:function(a){this.superInit(),this.setOrigin(0,0),this.lines=[];for(var b=0,c=a.lines.length;c>b;b++)this.lines.push(cannon.TerrainLine(tm.geom.Vector2(a.lines[b][0],a.lines[b][1]),tm.geom.Vector2(a.lines[b][2],a.lines[b][3])));this.scroll=0,this.strokeStyle="hsl(30, 80%, 80%)";var d=this;this.s=tm.display.Sprite(a.texture,8e3,640).setOrigin(0,0).setPosition(0,0).addChildTo(this).on("enterframe",function(){this.x=-d.scroll})},getHitLine:function(a){for(var b={x:a.x+this.scroll,y:a.y,radius:a.vsTerrainRadius||a.radius},c=this.lines,d=this.scroll,e=0,f=c.length;f>e;e++){var g=c[e],h=g.a,i=g.b;if((0<=h.x-d&&h.x-d<cannon.SC_W||0<=i.x-d&&i.x-d<cannon.SC_W)&&cannon.CollisionHelper.isHitCircleLine(b,g))return g}return null}}),tm.define("cannon.TerrainLine",{init:function(a,b){this.a=a,this.b=b}}),tm.define("cannon.WebGLParams",{superClass:"tm.app.Element",init:function(){this.superInit(),this._worldMatrix=tm.geom.Matrix44(),this.quake=0,this.labelAreaHeight=0,this.strength=0,this.centerOffset=[100,100],this.lightRadius=0}}),tm.define("cannon.Zako",{superClass:"cannon.Enemy",expType:0,hasTerrainCollider:!1,isGround:!1,init:function(a){this.superInit(),this.fromJSON({boundingType:"circle",radius:.2*a.size,score:a.score,hp:a.hp,expType:a.expType,size:a.size,basicFrameIndex:0,children:{body:{type:"tm.display.Sprite",init:[a.texture,2*a.size,2*a.size],frameIndex:0}}});var b=this;if(this.body.on("enterframe",function(a){this.setFrameIndex(b.muteki>0?a.app.frame%2:b.basicFrameIndex)}),"rot"===a.rotation)this.on("enterframe",function(){this.rotation+=6});else if("dir"===a.rotation){var c=0,d=0;this.on("enterframe",function(){this.rotation=Math.atan2(this.y-d,this.x-c)*Math.RAD_TO_DEG,c=this.x,d=this.y})}else this.rotation=0,this.scaleX=-1,this.originY=.33;this.on("dying",function(){this.basicFrameIndex=2,this.body.setFrameIndex(this.basicFrameIndex)})},destroy:function(){switch(this.expType){case 0:cannon.Explode(this.x,this.y).addChildTo(this.parent);break;case 1:cannon.LargeExplode(this.x,this.y).addChildTo(this.parent)}this.remove()},setRoute:function(a){this.setPosition(a[0].x,a[0].y);for(var b=this.tweener.clear(),c=0,d=a.length;d>c;c++)b.to(a[c],100);return this},setSineWaveMotion:function(a){this.setPosition(a.x,a.y);var b=a.ia;this.on("enterframe",function(){b+=a.va,this.x+=a.vx,this.y=a.y+Math.sin(b)*a.r})},setHorizontalMotion:function(a){this.setPosition(a.x,a.y),this.scaleX=a.vx<0?-1:1,this.on("enterframe",function(){this.x+=a.vx})},setHomingMotion:function(a,b){this.setPosition(a.x,a.y),this.velocity=tm.geom.Vector2().setAngle(a.initialDirection,1),this.on("enterframe",function(){this.age<500&&this.age%100<20&&this.age%2===0&&this.velocity.add(tm.geom.Vector2(b.x-this.x,b.y-this.y).mul(a.homing)).normalize(),this.position.add(tm.geom.Vector2.mul(this.velocity,a.speed))})},setRunMotion:function(a){this.setPosition(a.x,a.y),this.scaleX=a.vx<0?-1:1,this.hasTerrainCollider=!0,this.isGround=!0,this.on("hitterrain",function(b){for(var c={x:this.x+b.terrain.scroll,y:this.y,radius:this.radius},d=b.line;cannon.CollisionHelper.isHitCircleLine(c,d);)c.y-=.1*a.g,this.y-=.1*a.g}),this.on("enterframe",function(){this.x+=a.vx,this.y+=a.g})},setJumpMotion:function(a){this.setPosition(a.x,a.y),this.scaleX=a.vx<0?-1:1,this.hasTerrainCollider=!0,this.isGround=!0,this.on("hitterrain",function(c){for(var d={x:this.x+c.terrain.scroll,y:this.y,radius:this.radius},e=c.line;cannon.CollisionHelper.isHitCircleLine(d,e);)d.y-=.1*a.g,this.y-=.1*a.g,b=a.vy});var b=a.g;this.on("enterframe",function(){this.x+=a.vx,this.y+=b,b+=a.g})}}),tm.define("cannon.ZankiLabel",{superClass:"tm.display.CanvasElement",_zanki:0,init:function(){this.superInit(),this.fromJSON({children:Array.range(0,cannon.ZANKI_MAX).map(function(a){return{type:"tm.display.CanvasElement",x:64*a,children:[{type:"tm.display.RoundRectangleShape",init:[51.2,51.2,{fillStyle:"rgba(255, 255, 255, 0.1)",strokeStyle:"transparent"}],blendMode:"lighter"},{type:"tm.display.Sprite",init:["fighter",128,64],scaleX:.4,scaleY:.4,frameIndex:6,blendMode:"lighter"}]}})})}}),cannon.ZankiLabel.prototype.accessor("zanki",{get:function(){return this._zanki},set:function(a){this._zanki=a,this.children.forEach(function(b,c){b.visible=a-1>c})}}),tm.geom=tm.geom||{},function(){tm.define("tm.geom.Bezier",{vertices:null,init:function(a,b){b=b||10,this.vertices=[];for(var c=0;b>=c;c++){var d=tm.geom.Bezier.getPointOnCurve(a,c/b);this.vertices.push([d[0],d[1]])}}}),tm.geom.Bezier.getPointOnCurve=function(a,b){for(;a.length>1;){for(var c=[],d=0,e=a.length-1;e>d;d++)c[d]=[a[d][0]+(a[d+1][0]-a[d][0])*b,a[d][1]+(a[d+1][1]-a[d][1])*b];a=c}return a[0]}}(),cannon.CollisionHelper={isHitCircleLine:function(a,b){var c=tm.geom.Vector2,d=b.s||(b.s=c.sub(b.b,b.a)),e=c.sub(a,b.a),f=c.sub(a,b.b),g=a.radius*a.radius;return e.lengthSquared()<=g||f.lengthSquared()<=g?!0:Math.abs(c.cross(d,e))/d.length()>a.radius?!1:c.dot(e,d)*c.dot(f,d)<=0}},cannon.spline=function(a,b){for(var c=new Spline({points:a,duration:b}),d=[],e=0;b>e;e++)d.push(c.pos(e));return d},function(){function a(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}tm.graphics.Canvas.prototype.stackBlur=function(d){var e=this.width,f=this.height,g=(this.canvas,this.context);if(!(isNaN(d)||1>d)){d|=0;var h;try{try{h=g.getImageData(0,0,e,f)}catch(i){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),h=g.getImageData(0,0,e,f)}catch(i){throw alert("Cannot access local image"),new Error("unable to access local image data: "+i)}}}catch(i){throw alert("Cannot access image"),new Error("unable to access image data: "+i)}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H=h.data,I=d+d+1,J=e-1,K=f-1,L=d+1,M=L*(L+1)/2,N=new a,O=N;for(l=1;I>l;l++)if(O=O.next=new a,l==L)var P=O;O.next=N;var Q=null,R=null;p=o=0;var S=b[d],T=c[d];for(k=0;f>k;k++){for(y=z=A=B=q=r=s=t=0,u=L*(C=H[o]),v=L*(D=H[o+1]),w=L*(E=H[o+2]),x=L*(F=H[o+3]),q+=M*C,r+=M*D,s+=M*E,t+=M*F,O=N,l=0;L>l;l++)O.r=C,O.g=D,O.b=E,O.a=F,O=O.next;for(l=1;L>l;l++)m=o+((l>J?J:l)<<2),q+=(O.r=C=H[m])*(G=L-l),r+=(O.g=D=H[m+1])*G,s+=(O.b=E=H[m+2])*G,t+=(O.a=F=H[m+3])*G,y+=C,z+=D,A+=E,B+=F,O=O.next;for(Q=N,R=P,j=0;e>j;j++)H[o+3]=F=t*S>>T,0!=F?(F=255/F,H[o]=(q*S>>T)*F,H[o+1]=(r*S>>T)*F,H[o+2]=(s*S>>T)*F):H[o]=H[o+1]=H[o+2]=0,q-=u,r-=v,s-=w,t-=x,u-=Q.r,v-=Q.g,w-=Q.b,x-=Q.a,m=p+((m=j+d+1)<J?m:J)<<2,y+=Q.r=H[m],z+=Q.g=H[m+1],A+=Q.b=H[m+2],B+=Q.a=H[m+3],q+=y,r+=z,s+=A,t+=B,Q=Q.next,u+=C=R.r,v+=D=R.g,w+=E=R.b,x+=F=R.a,y-=C,z-=D,A-=E,B-=F,R=R.next,o+=4;p+=e}for(j=0;e>j;j++){for(z=A=B=y=r=s=t=q=0,o=j<<2,u=L*(C=H[o]),v=L*(D=H[o+1]),w=L*(E=H[o+2]),x=L*(F=H[o+3]),q+=M*C,r+=M*D,s+=M*E,t+=M*F,O=N,l=0;L>l;l++)O.r=C,O.g=D,O.b=E,O.a=F,O=O.next;for(n=e,l=1;d>=l;l++)o=n+j<<2,q+=(O.r=C=H[o])*(G=L-l),r+=(O.g=D=H[o+1])*G,s+=(O.b=E=H[o+2])*G,t+=(O.a=F=H[o+3])*G,y+=C,z+=D,A+=E,B+=F,O=O.next,K>l&&(n+=e);for(o=j,Q=N,R=P,k=0;f>k;k++)m=o<<2,H[m+3]=F=t*S>>T,F>0?(F=255/F,H[m]=(q*S>>T)*F,H[m+1]=(r*S>>T)*F,H[m+2]=(s*S>>T)*F):H[m]=H[m+1]=H[m+2]=0,q-=u,r-=v,s-=w,t-=x,u-=Q.r,v-=Q.g,w-=Q.b,x-=Q.a,m=j+((m=k+L)<K?m:K)*e<<2,q+=y+=Q.r=H[m],r+=z+=Q.g=H[m+1],s+=A+=Q.b=H[m+2],t+=B+=Q.a=H[m+3],Q=Q.next,u+=C=R.r,v+=D=R.g,w+=E=R.b,x+=F=R.a,y-=C,z-=D,A-=E,B-=F,R=R.next,o+=e}return g.putImageData(h,0,0),this}};var b=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],c=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24]}(),function(){tm.define("WebGLise",{init:function(a){this.app=a;var b=this.params=cannon.WebGLParams();a.element.style.display="none";var c=tm.graphics.Canvas();c.element.style.display="none",c.resize(512,512);var d=document.createElement("canvas");document.body.appendChild(d),d.width=a.width,d.height=a.height;var e=function(){var a=d.style;a.position="absolute",a.margin="auto",a.left="0px",a.top="0px",a.bottom="0px",a.right="0px";var b=d.width/window.innerWidth,c=d.height/window.innerHeight,e=d.height/d.width;b>c?(a.width=innerWidth+"px",a.height=innerWidth*e+"px"):(a.width=innerHeight/e+"px",a.height=innerHeight+"px")}.bind(this);e(),window.addEventListener("resize",e,!1);var f=d.getContext("webgl");f.clearColor(0,0,0,1),f.clearDepth(1);var g=f.createShader(f.VERTEX_SHADER);f.shaderSource(g,WebGLise.vs),f.compileShader(g);var h=f.createShader(f.FRAGMENT_SHADER);f.shaderSource(h,WebGLise.fs),f.compileShader(h);var i=f.createProgram();f.attachShader(i,g),f.attachShader(i,h),f.linkProgram(i),f.useProgram(i);var j={position:f.getAttribLocation(i,"position"),texCoord:f.getAttribLocation(i,"texCoord")},k={matMvp:f.getUniformLocation(i,"matMvp"),texture:f.getUniformLocation(i,"texture"),labelAreaHeight:f.getUniformLocation(i,"labelAreaHeight"),strength:f.getUniformLocation(i,"strength"),centerOffset:f.getUniformLocation(i,"centerOffset"),lightRadius:f.getUniformLocation(i,"lightRadius")},l=[-1,1,0,1,1,0,1,-1,0,1,-1,0,-1,-1,0,-1,1,0],m=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,m),f.bufferData(f.ARRAY_BUFFER,new Float32Array(l),f.STATIC_DRAW),f.enableVertexAttribArray(j.position),f.vertexAttribPointer(j.position,3,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,null);var n=[0,0,1,0,1,1,1,1,0,1,0,0],o=f.createBuffer();f.bindBuffer(f.ARRAY_BUFFER,o),f.bufferData(f.ARRAY_BUFFER,new Float32Array(n),f.STATIC_DRAW),f.enableVertexAttribArray(j.texCoord),f.vertexAttribPointer(j.texCoord,2,f.FLOAT,!1,0,0),f.bindBuffer(f.ARRAY_BUFFER,null);var p=f.createTexture();f.bindTexture(f.TEXTURE_2D,p),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE);var q=mat4.create(),r=mat4.create(),s=mat4.create(),t=mat4.create();mat4.lookAt(r,[0,0,1],[0,0,0],[0,1,0]),mat4.ortho(s,-1,1,-1,1,.1,2),mat4.multiply(t,s,r),mat4.multiply(t,q,t),f.uniformMatrix4fv(k.matMvp,!1,t);var u=function(){f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT),mat4.identity(q),b.quake>0&&(mat4.translate(q,q,[Math.randf(.01*-b.quake,.01*b.quake),Math.randf(.01*-b.quake,.01*b.quake),0]),mat4.rotateZ(q,q,Math.randf(.01*-b.quake,.01*b.quake))),mat4.multiply(t,s,r),mat4.multiply(t,q,t),f.uniformMatrix4fv(k.matMvp,!1,t),c.drawImage(a.element,0,0,a.width,a.height,0,0,c.width,c.height),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,c.element),f.generateMipmap(f.TEXTURE_2D),f.uniform1i(k.texture,0),f.uniform1f(k.labelAreaHeight,b.labelAreaHeight),f.uniform1f(k.strength,b.strength),f.uniform2fv(k.centerOffset,b.centerOffset),f.uniform1f(k.lightRadius,b.lightRadius),f.drawArrays(f.TRIANGLES,0,6),f.flush()};a.update=function(){u()}}}),WebGLise.vs="\nattribute vec3 position;\nattribute vec2 texCoord;\nuniform mat4 matMvp;\nvarying vec4 vColor;\nvarying vec2 vTexCoord;\n\nvoid main(void) {\n    vTexCoord = texCoord;\n    gl_Position = matMvp * vec4(position, 1.0);\n}\n",WebGLise.fs="\nprecision mediump float;\n\nuniform sampler2D texture;\nuniform float labelAreaHeight;\nuniform float strength;\nuniform vec2 centerOffset;\nuniform float lightRadius;\n\nvarying vec4 vColor;\nvarying vec2 vTexCoord;\n\nconst float tFragX = 1.0 / 960.0;\nconst float tFragY = 1.0 / 640.0;\nconst float nFrag = 1.0 / 30.0;\n// const vec2 centerOffset = vec2(960.0 / 2.0, 640.0 / 2.0);\n\nfloat rnd(float seed){\n    return fract(sin(dot(gl_FragCoord.stp + seed, vec3(12.9898, 78.233, 151.7182))) * 43758.5453 + seed);\n}\n\nvoid main(void) {\n    vec4 result;\n\n    vec2 fc = vec2(gl_FragCoord.x, 640.0 - gl_FragCoord.y);\n    vec2 fcc = fc - centerOffset;\n\n    vec4 blured;\n    if (strength > 0.001) {\n        vec3 temp = vec3(0.0);\n        float random = rnd(604.361);\n        float totalWeight = 0.0;\n\n        for(float i = 0.0; i <= 30.0; i++){\n            float percent = (i + random) * nFrag;\n            float weight = percent - percent * percent;\n            vec2 t = fc - fcc * percent * strength * nFrag;\n            temp += texture2D(texture, vec2(t.x * tFragX, t.y * tFragY)).rgb * weight;\n            totalWeight += weight;\n        }\n        blured = vec4(temp / totalWeight, 1.0);\n    } else {\n        blured = texture2D(texture, vTexCoord);\n    }\n\n    if (lightRadius > 0.001) {\n        float addition = clamp((lightRadius - length(fcc)) / lightRadius, 0.0, 1.0);\n        blured += vec4(vec3(addition), 0.0);\n        blured += vec4(vec3(addition), 0.0);\n    }\n\n    if (320.0 - labelAreaHeight <= gl_FragCoord.y && gl_FragCoord.y < 320.0 + labelAreaHeight) {\n        vec3 neg = vec3(1.0 - blured.r, 1.0 - blured.g, 1.0 - blured.b);\n        result = vec4(neg.r * 0.62, neg.g * 0.10, neg.b * 0.12, blured.a);\n    } else {\n        result = blured;\n    }\n\n    gl_FragColor = result;\n}\n"}(),tm.main(function(){cannon.app=cannon.Application("#main"),"localhost"===location.hostname&&(tm.util.Script.loadStats().onload=function(){cannon.app.enableStats()});var a=["MagicRing","Orbitron","ShareTechMono"].map(function(a){var b={loaded:!1},c=document.createElement("span");c.style.fontFamily="'{0}', 'monospace'".format(a),c.innerHTML="QW@HhsXJ",document.body.appendChild(c);var d=c.offsetWidth,e=30,f=function(){e-=1,c.offsetWidth!==d||0>e?(document.body.removeChild(c),b.loaded=!0):setTimeout(f,100)};return f(),b}),b=function(){a.some(function(a){return!a.loaded})?setTimeout(b,100):cannon.app.run()};b()}),cannon.ATTACK_DATA={},function(){for(var a=bulletml.dsl.action,b=(bulletml.dsl.actionRef,bulletml.dsl.bullet),c=(bulletml.dsl.bulletRef,bulletml.dsl.fire),d=(bulletml.dsl.fireRef,bulletml.dsl.changeDirection,bulletml.dsl.changeSpeed,bulletml.dsl.accel,bulletml.dsl.wait),e=(bulletml.dsl.vanish,bulletml.dsl.repeat),f=(bulletml.dsl.bindVar,bulletml.dsl.notify,bulletml.dsl.direction),g=bulletml.dsl.speed,h=(bulletml.dsl.horizontal,bulletml.dsl.vertical,bulletml.dsl.fireOption,bulletml.dsl.offsetX,bulletml.dsl.offsetY),i=(bulletml.dsl.autonomy,function(a){return g("{0} * 3 * (1 + Math.sqrt($rank) * 2)".format(a))}),j=function(a){return d("{0} / (1 + Math.sqrt($rank))".format(a))},k=0;5>k;k++)cannon.ATTACK_DATA["simpleA{0}".format(k)]=new bulletml.Root({top:a([j(250+5*k),e(999,[c(i(1),b()),j(300)])])}),cannon.ATTACK_DATA["simpleB{0}".format(k)]=new bulletml.Root({top:a([j(250+5*k),e(999,[c(i(1),b()),e(3,[c(i(1),b()),d(15)]),j(300)])])}),cannon.ATTACK_DATA["around{0}".format(k)]=new bulletml.Root({top:a([j(250+5*k),e(999,[e(10,[c(f(36,"sequence"),i(.8),b())]),j(300)])])});cannon.ATTACK_DATA.horizontal2=new bulletml.Root({top:a([e(999,[j(130),e(6,[c(f(-90,"absolute"),i(1.5),b({color:1}),h(-20)),c(f(-90,"absolute"),i(1.5),b({color:1}),h(20)),d(3)])])])}),cannon.ATTACK_DATA["4way"]=new bulletml.Root({top:a([e(999,[j(130),e(2,[c(f(-45),i(1.5),b({color:2})),c(f(-15),i(1.5),b({color:2})),c(f(15),i(1.5),b({color:2})),c(f(45),i(1.5),b({color:2})),d(50)])])])})}(),cannon.ENEMY_DATA=[{texture:"enemy0",size:128,score:500,hp:8,expType:1,rotation:"fix"},{texture:"enemy1",size:64,score:100,hp:1,expType:0,rotation:"fix"},{texture:"enemy2",size:64,score:100,hp:1,expType:0,rotation:"fix"},{texture:"enemy3",size:64,score:100,hp:1,expType:0,rotation:"dir"},{texture:"enemy4",size:128,score:500,hp:8,expType:1,rotation:"fix"},{texture:"enemy5",size:128,score:500,hp:8,expType:1,rotation:"fix"},{texture:"enemy6",size:64,score:300,hp:1,expType:0,rotation:"fix"},{texture:"enemy7",size:64,score:100,hp:1,expType:0,rotation:"rot"},{texture:"enemy8",size:64,score:100,hp:1,expType:0,rotation:"rot"},{texture:"enemy9",size:64,score:100,hp:1,expType:0,rotation:"rot"},{texture:"enemy10",size:64,score:100,hp:1,expType:0,rotation:"rot"},{texture:"enemy11",size:64,score:100,hp:1,expType:0,rotation:"rot"},{texture:"enemy12",size:64,score:100,hp:1,expType:0,rotation:"rot"},{texture:"enemy13",size:64,score:100,hp:1,expType:0,rotation:"rot"},{texture:"enemy14",size:64,score:100,hp:1,expType:0,rotation:"rot"}],cannon.BOSS1_DATA={parts:[{texture:"boss1_2",size:128,radius:40,score:500,hp:30,expType:1,x:80,y:80,scaleX:1.3,scaleY:1.3,delay:5},{texture:"boss1_3",size:128,radius:40,score:500,hp:30,expType:1,x:-40,y:140,scaleX:1.3,scaleY:1.3,delay:10},{texture:"boss1_2",size:128,radius:40,score:500,hp:30,expType:1,x:80,y:-80,scaleX:1.3,scaleY:-1.3,delay:5},{texture:"boss1_3",size:128,radius:40,score:500,hp:30,expType:1,x:-40,y:-140,scaleX:1.3,scaleY:-1.3,delay:10},{texture:"boss1_1",size:128,radius:40,score:500,hp:50,expType:1,x:0,y:0,scaleX:1.7,scaleY:1.7,delay:0}]},cannon.STAGE_DATA=[],function(){var a=function(a){return{type:"wait",value:a}},b=function(a,b,c){return{type:"enemy",attack:"simpleA{5}",enemyType:3,motionType:"homing",data:{x:a,y:b,initialDirection:c,speed:3,homing:.001}}},c=function(a){return{type:"enemy",attack:"4way",enemyType:4,motionType:"horizontal",data:{x:1060,y:a,vx:-1.4}}},d=function(a){return{type:"enemy",attack:"horizontal2",enemyType:5,motionType:"horizontal",data:{x:1060,y:a,vx:-1.4}}},e=function(a,b,c){return{type:"enemy",attack:"simpleB{5}",enemyType:6,motionType:"run",data:{x:a,y:b,vx:c,g:6}}},f=function(a,b,c){return{type:"enemy",attack:"simpleB{5}",enemyType:6,motionType:"run",data:{x:a,y:b,vx:c,g:-6}}},g=function(a,b,c){return{type:"enemy",attack:"around{5}",enemyType:13,motionType:"jump",data:{x:a,y:b,vx:c,vy:-12,g:.3}}},h=function(a,b,c){return{type:"enemy",attack:"around{5}",enemyType:13,motionType:"jump",data:{x:a,y:b,vx:c,vy:12,g:-.3}}},i=function(a){var b;switch(a){case 0:b=cannon.spline([{x:320,y:-100},{x:100,y:320},{x:320,y:540},{x:760,y:540},{x:860,y:320},{x:480,y:320},{x:-100,y:320}],100);break;case 1:b=cannon.spline([{x:640,y:-100},{x:860,y:320},{x:640,y:540},{x:200,y:540},{x:100,y:320},{x:480,y:320},{x:1060,y:320}],100)}return{type:"enemy",attack:null,enemyType:7,motionType:"route",data:b}},j=function(a){var b;switch(a){case 0:b=cannon.spline([{x:900,y:-100},{x:900,y:600},{x:600,y:270},{x:-200,y:270}],60);break;case 1:b=cannon.spline([{x:900,y:760},{x:900,y:40},{x:600,y:370},{x:-200,y:370}],60);break;case 2:b=cannon.spline([{x:900,y:-100},{x:900,y:600},{x:600,y:315},{x:-200,y:315}],60);break;case 3:b=cannon.spline([{x:900,y:760},{x:900,y:40},{x:600,y:325},{x:-200,y:325}],60);break;case 4:b=cannon.spline([{x:60,y:-100},{x:60,y:600},{x:360,y:270},{x:1160,y:270}],60);break;case 5:b=cannon.spline([{x:60,y:760},{x:60,y:40},{x:360,y:370},{x:1160,y:370}],60)}return{type:"enemy",attack:null,enemyType:8,motionType:"route",data:b}},k=function(a,b,c){return{type:"enemy",attack:"simpleA{5}",enemyType:10,motionType:"sine",data:{x:a,y:b,vx:-2,ia:Math.PI*c,va:.04,r:120}}};cannon.STAGE_DATA[0]={assets:{"terrain/stage1":"images/terrainStage1.png","background/stage1":"images/backgroundStage1.png","bgm/stage1":"sounds/nc67883.mp3"},bgm:"bgm/stage1",bgmLoopRange:[14.142,151.285],background:{texture:"background/stage1"},terrain:{texture:"terrain/stage1",lines:[[383,-12,434,1],[433,-1,520,4],[520,4,656,-1],[656,-1,815,6],[815,6,986,-2],[1356,-6,1471,60],[1471,60,1496,59],[1496,59,1558,19],[1558,19,1661,-8],[1810,-8,1845,39],[1845,39,1885,14],[1885,14,1887,-12],[2180,-4,2209,13],[2209,13,2257,10],[2257,10,2271,16],[2271,16,2313,20],[2313,20,2337,12],[2337,12,2419,22],[2419,22,2447,31],[2447,31,2463,42],[2463,42,2553,43],[2552,43,2596,44],[2596,44,2633,36],[2633,36,2786,41],[2786,41,2847,43],[2847,43,2934,39],[2934,39,2997,42],[2997,42,3060,33],[3060,34,3242,25],[3241,23,3324,30],[3324,29,3392,18],[3392,18,3496,33],[3496,33,3554,34],[3554,34,3626,60],[3626,60,3678,75],[3674,73,3756,42],[3756,42,3912,23],[3912,23,4018,33],[4018,33,4102,39],[4102,39,4186,79],[4186,79,4242,87],[4238,89,4337,62],[4337,61,4442,56],[4442,56,4580,38],[4579,35,4612,43],[4612,43,4867,29],[4867,29,4880,23],[4880,23,5117,44],[5116,43,5245,27],[5245,27,5470,47],[5470,47,5558,31],[5558,31,5713,39],[5713,39,5742,33],[5742,33,5939,53],[5939,50,6166,61],[6166,61,6277,58],[6277,58,6426,54],[6426,53,6495,43],[6495,43,6648,55],[6648,55,6777,97],[6775,96,6902,160],[6902,161,6953,121],[6953,121,7058,57],[7058,57,7239,-6],[1848,665,1860,630],[1860,630,1936,632],[1934,630,1956,627],[1956,627,2058,623],[2058,623,2102,615],[2102,615,2188,609],[2188,609,2370,608],[2370,609,2607,622],[2607,622,2818,627],[2822,627,2909,611],[2909,610,3140,630],[3137,630,3232,615],[3232,615,3428,633],[3428,633,3766,614],[3765,614,3792,620],[3791,620,3943,602],[3942,602,4006,606],[4005,606,4138,567],[4137,564,4147,573],[4147,573,4204,580],[4203,579,4257,610],[4257,610,4428,634],[4430,633,4545,627],[4549,627,4611,619],[4611,619,4703,584],[4706,582,4802,618],[4802,618,4974,635],[4973,635,5057,630],[5056,629,5131,633],[5131,633,5339,623],[5338,623,5531,614],[5539,612,5585,615],[5589,617,5710,619],[5711,619,5818,611],[5818,611,5916,606],[5912,607,5928,615],[5927,615,5990,626],[5990,626,6158,624],[6158,624,6164,610],[6164,610,6203,630],[6203,630,6331,633],[6331,633,6356,626],[6356,626,6366,641],[6366,641,6470,621],[6470,621,6525,563],[6526,563,6536,563],[6536,563,6571,601],[6574,601,6630,618],[6638,619,6704,604],[6704,604,6824,550],[6824,550,6880,510],[6878,509,6917,513],[6915,512,7008,570],[7008,570,7109,611],[7109,611,7135,608],[7135,608,7170,630],[7170,630,7211,626],[7211,626,7305,641],[7305,641,7333,633],[7333,633,7394,657]]},scrollSpeed:1,stageStep:[a(100),a(100),j(0),a(10),j(0),a(10),j(0),a(10),j(0),a(10),j(0),a(150),j(1),a(10),j(1),a(10),j(1),a(10),j(1),a(10),j(1),a(150),j(0),a(10),j(0),a(10),j(0),a(10),j(0),a(10),j(0),a(150),j(1),a(10),j(1),a(10),j(1),a(10),j(1),a(10),j(1),a(250),j(2),j(3),a(10),j(2),j(3),a(10),j(2),j(3),a(10),j(2),j(3),a(10),j(2),j(3),e(1060,480,-2),f(-100,160,2),a(200),c(160),c(480),a(200),k(1060,270,0),k(1160,270,1),k(1260,270,0),k(1360,270,1),f(1060,160,-2),e(-100,480,2),a(200),k(1060,370,0),k(1160,370,1),k(1260,370,0),k(1360,370,1),a(250),d(320),a(100),d(290),a(120),d(260),a(80),d(220),a(250),b(-100,128,90),b(-100,256,90),b(-100,384,90),b(-100,512,90),a(150),j(1),a(10),j(1),a(10),j(1),a(10),j(1),a(10),j(1),a(150),j(4),a(10),j(4),a(10),j(4),a(10),j(4),a(10),j(4),e(1060,480,-2),a(150),j(5),a(10),j(5),a(10),j(5),a(10),j(5),a(10),j(5),e(1060,480,-2),f(-100,160,2),a(200),c(160),c(480),a(250),b(-100,128,90),b(-100,256,90),b(-100,384,90),b(-100,512,90),b(1060,128,-90),b(1060,256,-90),b(1060,384,-90),b(1060,512,-90),a(150),f(1060,160,-2),e(-100,480,2),a(150),i(1),a(15),i(1),a(15),i(1),a(15),i(1),a(15),i(1),a(15),a(150),i(0),a(15),i(0),a(15),i(0),a(15),i(0),a(15),i(0),a(15),a(250),g(-100,480,2),g(1060,480,-2),h(-100,160,2),a(250),j(0),a(10),j(0),a(10),j(0),a(10),j(0),a(10),j(0),a(250),j(5),a(10),j(5),a(10),j(5),a(10),j(5),a(10),j(5),a(250),g(1060,480,-2),h(1060,160,-2),a(250),j(1),j(5),a(10),j(1),j(5),a(10),j(1),j(5),a(10),j(1),j(5),a(10),j(1),j(5),a(250),g(-100,480,2),h(-100,160,2),a(250),d(160),d(320),d(480),a(120),d(240),d(400),a(120),d(160),d(480),a(500),{type:"boss",boss:"cannon.Boss1"}]}
}();
//# sourceMappingURL=cannon-stg.min.js.map