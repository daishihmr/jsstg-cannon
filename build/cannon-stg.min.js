/*
 * 破壊せよ！キャノンさん v0.0.1
 * http://www.dev7.jp
 * 
 * The MIT License (MIT)
 * Copyright © 2014 daishi_hmr, dev7.jp
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */


var cannon={app:null,SC_W:960,SC_H:640,FIGHTER_RADIUS:20,FIGHTER_SPEED:12,SHOT_SPEED:40,HEAT_BY_SHOT:15};cannon.optionSettings={seVolume:.5,bgmVolume:.5},tm.display.Label.default.fontFamily="OFL",cannon.ASSETS={fighter:"images/fighter.png",aura:"images/aura.png",shot:"images/shot.png",backfire:"images/backfire.png",explode0:"images/exp_s.png",explode1:"images/exp_l.png","sounds/extend":"sounds/extend.mp3"},Math.PHI=1.61803399,tm.main(function(){cannon.app=cannon.Application("#main"),cannon.app.fps=60,cannon.app.resize(cannon.SC_W,cannon.SC_H).fitWindow().replaceScene(tm.ui.LoadingScene({width:cannon.SC_W,height:cannon.SC_H,assets:cannon.ASSETS,nextScene:cannon.GameScene}));var a=document.createElement("span");a.style.fontFamily="'OFL', 'monospace'",a.innerHTML="QW@HhsXJ",document.body.appendChild(a);var b=a.offsetWidth,c=20,d=function(){c-=1,a.offsetWidth!==b||0>c?(document.body.removeChild(a),cannon.app.run()):setTimeout(d,100)};d()}),tm.define("cannon.Application",{superClass:"tm.display.CanvasApp",init:function(a){this.superInit(a),this.keyboard.element.addEventListener("keydown",function(a){37<=a.keyCode&&a.keyCode<=40&&a.preventDefault()},!1)}}),cannon.playSe=function(a){tm.asset.Manager.get(a).clone().setVolume(cannon.optionSettings.seVolume).play()},cannon.playBgm=function(a){tm.asset.Manager.get(a).clone().setVolume(cannon.optionSettings.bgmVolume).play()},tm.define("cannon.GameScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.fromJSON({children:{backgroundLayer:{type:"tm.display.CanvasElement",children:{bg:{type:"cannon.Background"}}},playerLayer:{type:"tm.display.CanvasElement",children:{player:{type:"cannon.Fighter",scene:this}}},enemyLayer:{type:"tm.display.CanvasElement",children:{}},terrainLayer:{type:"tm.display.CanvasElement",children:{ceil:{type:"cannon.Terrain",init:[CEIL]},floor:{type:"cannon.Terrain",init:[FLOOR]}}},bulletLayer:{type:"tm.display.CanvasElement",children:{}}}}),this.player=this.playerLayer.player},update:function(){var a=this.player;this.terrainLayer.children.forEach(function(a){a.scroll+=1}),this.terrainLayer.children.some(function(b){return b.isHit(a)})&&a.damage()}});var CEIL=[0,100,120,90,120,120,90,120,120,90,120,120,90,120,120,500],FLOOR=[500,600,620,490,520,520,690,620,620,690,620,620,690,620,620,700];tm.define("cannon.MenuDialog",{superClass:"tm.ui.MenuDialog",init:function(a,b,c,d){this.superInit({title:a,menu:b,menuDesctiptions:c,defaultIndex:d||0,showExit:!0,screenWidth:cannon.SC_W,screenHeight:cannon.SC_H,backgroundColor:"hsla(200, 80%, 5%, 0.9)",boxColor:"hsla(200, 80%, 10%, 0.9)",cursorColor:"hsla(200, 80%, 30%, 0.9)"}),this.on("preselected",function(){cannon.playSe("sounds/extend")}),this.on("canceled",function(){cannon.playSe("sounds/extend")})}}),tm.define("cannon.TitleScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.setInteractive(!0),this.fromJSON({children:{title:{type:"tm.display.Label",init:["ETA Boost",72],x:.5*cannon.SC_W,y:cannon.SC_H*(1-1/Math.PHI)}}})},onpointingend:function(){var a=this;cannon.app.pushScene(cannon.MenuDialog("MENU",["game start","option"],["ゲームスタート","設定"]).on("selected",function(b){switch(b.value){case"game start":a.startGame()}}))},startGame:function(){cannon.app.replaceScene(cannon.GameScene())}}),tm.define("cannon.Background",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.fromJSON({children:{bg:{type:"tm.display.Sprite",init:tm.graphics.Canvas().resize(cannon.SC_W,cannon.SC_H).setFillStyle("black").fillRect(0,0,cannon.SC_W,cannon.SC_H),originX:0,originY:0}}})}}),tm.define("cannon.Explode",{superClass:"tm.display.Sprite",init:function(a,b){this.superInit("explode0",128,128),this.setPosition(a,b).setBlendMode("lighter").setFrameIndex(0)},update:function(a){a.frame%2===0&&(this.frameIndex+=1,0===this.frameIndex&&this.remove())}}),tm.define("cannon.LargeExplode",{superClass:"tm.display.Sprite",init:function(a,b){this.superInit("explode1",128,128),this.setScale(3).setPosition(a,b).setBlendMode("lighter").setFrameIndex(0)},update:function(a){a.frame%2===0&&(this.frameIndex+=1,0===this.frameIndex&&this.remove())}}),tm.define("cannon.Fighter",{superClass:"tm.display.CanvasElement",scene:null,init:function(){this.superInit(),this.fromJSON({children:{aura:{type:"tm.display.Sprite",init:["aura",80,120],frameIndex:0,x:-50,y:5,scaleY:.75},body:{type:"tm.display.Sprite",init:["fighter",128,64],frameIndex:2}}}),this.setBoundingType("circle"),this.radius=cannon.FIGHTER_RADIUS,this.beforeX=this.x=.5*cannon.SC_W,this.beforeY=this.y=.5*cannon.SC_H,this.roll=0,this.heat=0,this.aura.update=function(a){this.setFrameIndex(a.frame%4),this.scaleX=[.8,1,1.2,1][a.frame%4]}},update:function(a){var b=a.keyboard,c=b.getKeyDirection();this.position.add(c.mul(cannon.FIGHTER_SPEED)),this.x=Math.clamp(this.x,32,cannon.SC_W-32),this.y=Math.clamp(this.y,16,cannon.SC_H-16),c.y<0?this.roll-=.1:0<c.y?this.roll+=.1:(this.roll*=.9,-.01<this.roll&&this.roll<.01&&(this.roll=0)),this.roll=Math.clamp(this.roll,-2,2),this.body.setFrameIndex(~~(2+this.roll+.5)),b.getKeyDown("z")&&this.heat<=0?(cannon.Shot().setPosition(this.x+50,this.y+10).addChildTo(this.parent),this.heat=cannon.HEAT_BY_SHOT):this.heat>0&&(this.heat-=1)},damage:function(){console.log("damage!")}}),tm.define("cannon.Shot",{superClass:"tm.display.Sprite",init:function(){this.superInit("shot"),this.setScale(3)},update:function(){this.x+=cannon.SHOT_SPEED}}),tm.define("cannon.Terrain",{superClass:"tm.display.CanvasElement",init:function(a){this.superInit(),this.setOrigin(0,0),this.lines=[];for(var b=0,c=a.length;c>b;b++)this.lines.push({a:tm.geom.Vector2(100*b,a[b]),b:tm.geom.Vector2(100*(b+1),a[b+1])});this.scroll=0,this.strokeStyle="hsl(30, 80%, 80%)"},draw:function(a){var b=a,c=this.lines,d=this.scroll;b.lineWidth=2,b.beginPath();for(var e=0,f=c.length;f>e;e++){var g=c[e];b.moveTo(g.a.x-d,g.a.y),b.lineTo(g.b.x-d,g.b.y)}b.stroke()},isHit:function(a){for(var b={x:a.x+this.scroll,y:a.y,radius:a.radius},c=this.lines,d=0,e=c.length;e>d;d++){var f=c[d];if(f.a.x<b.x-b.radius&&b.x+b.radius<f.b.x&&cannon.CollisionHelper.isHitCircleLine(b,f))return!0}return!1}}),cannon.CollisionHelper={isHitCircleLine:function(a,b){var c=tm.geom.Vector2,d=b.s||(b.s=c.sub(b.b,b.a)),e=c.sub(a,b.a),f=c.sub(a,b.b),g=a.radius*a.radius;return e.lengthSquared()<=g||f.lengthSquared()<=g?!0:Math.abs(c.cross(d,e))/d.length()>a.radius?!1:c.dot(e,d)*c.dot(f,d)<=0}};
//# sourceMappingURL=cannon-stg.min.js.map