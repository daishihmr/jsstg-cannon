/*
 * Deep Striker v0.0.1
 * http://www.dev7.jp
 * 
 * The MIT License (MIT)
 * Copyright © 2014 daishi_hmr, dev7.jp
 * 
 * Permission is hereby granted, free of charge, to any person obtaining a copy of this software and
 * associated documentation files (the “Software”), to deal in the Software without restriction, including
 * without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies
 * of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following
 * conditions:
 * 
 * The above copyright notice and this permission notice shall be included in all copies or substantial portions
 * of the Software.
 * 
 * THE SOFTWARE IS PROVIDED “AS IS”, WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 */


var cannon={};!function(){var a=960,b=640;cannon.app=null,cannon.SC_W=a,cannon.SC_H=b,cannon.FIGHTER_RADIUS=a/96,cannon.FIGHTER_SPEED=a/100,cannon.SHOT_SPEED=a/32,cannon.HEAT_BY_SHOT=18,cannon.SHOT_POWER=3,cannon.SHOT_RADIUS=a/64,cannon.ZANKI_MAX=10,cannon.RANK_MAX=3e3,cannon.optionSettings={seVolume:.1,bgmVolume:.5},tm.display.Label.default.fontFamily="OFL",cannon.ASSETS={fighter:"images/fighter.png",aura:"images/aura.png",shot:"images/shot.png",backfire:"images/backfire.png",explode0:"images/exp_s.png",explode1:"images/exp_l.png",explodeBlue:"images/exp_blue.png",shockwave:"images/shockwave.png",spark:"images/spark.png",spark2:"images/spark2.png",boost:"images/boost.png",bullet:"images/bullet.png",scorerate:"images/scorerate.png","sounds/extend":"sounds/extend.mp3","sounds/reload":"sounds/sen_ge_gun_otosu03.mp3","sounds/shot":"sounds/gun2.mp3","sounds/explode0":"sounds/sen_ge_taihou03.mp3","sounds/explode1":"sounds/sen_ge_bom14.mp3"},Array.range(0,15).forEach(function(a){cannon.ASSETS["enemy{0}".format(a)]="images/enemy{0}.png".format(a)}),Math.PHI=1.61803399}(),cannon.onAssetsLoaded=function(a){return function(){return Array.range(0,15).forEach(function(a){var b="enemy{0}".format(a),c=tm.asset.Manager.get(b),d=tm.graphics.Canvas().resize(2*c.width,2*c.height);d.drawTexture(c,.5*c.width,.5*c.height,c.width,c.height),d.stackBlur(50);var e=tm.graphics.Canvas().resize(c.width,c.height);e.drawTexture(c,0,0),e.strokeStyle="transparent";for(var f=0;f<e.height;f+=3)e.clear(0,f,e.width,1);var g=tm.graphics.Canvas().resize(2*c.width*2,2*c.height);g.globalCompositeOperation="lighter",g.globalAlpha=.12;for(var a=0;10>a;a++)g.drawImage(d.canvas,0,0);g.globalCompositeOperation="source-over",g.globalAlpha=1,g.drawImage(e.canvas,.5*c.width,.5*c.height,c.width,c.height),g.globalCompositeOperation="lighter",g.globalAlpha=.12;for(var a=0;15>a;a++)g.drawImage(d.canvas,2*c.width,0);g.globalCompositeOperation="lighter",g.globalAlpha=1;for(var a=0;3>a;a++)g.drawImage(e.canvas,2.5*c.width,.5*c.height,c.width,c.height);tm.asset.Manager.set(b,g)}),a()}},tm.define("cannon.Application",{superClass:"tm.display.CanvasApp",init:function(a){this.superInit(a),this.keyboard.element.addEventListener("keydown",function(a){(37<=a.keyCode&&a.keyCode<=40||32===a.keyCode)&&a.preventDefault()},!1),this.canvas.imageSmoothingEnabled=!1}}),cannon.playSe=function(a){tm.asset.Manager.get("sounds/"+a).clone().setVolume(cannon.optionSettings.seVolume).play()},cannon.playBgm=function(a){tm.asset.Manager.get("sounds/"+a).clone().setVolume(cannon.optionSettings.bgmVolume).play()},function(){var a=0,b=0,c=3;tm.define("cannon.GameScene",{superClass:"tm.app.Scene",init:function(d){this.superInit(),this.stageIndex=d||0,this.fromJSON({children:{backgroundLayer:{type:"tm.display.CanvasElement",children:{bg:{type:"cannon.Background"}}},playerLayer:{type:"tm.display.CanvasElement",children:{player:{type:"cannon.Fighter",scene:this,controllable:!1}}},terrainLayer:{type:"tm.display.CanvasElement",children:[{type:"cannon.Terrain",init:[cannon.STAGE_DATA[this.stageIndex].terrain]}]},enemyLayer:{type:"tm.display.CanvasElement"},bulletLayer:{type:"tm.display.CanvasElement"},uiLayer:{type:"tm.display.CanvasElement",children:{scoreLabel:{type:"cannon.ScoreLabel",x:cannon.SC_W-5,y:5},rankLabel:{type:"cannon.RankLabel",x:5,y:5},zankiLabel:{type:"cannon.ZankiLabel",x:37,y:cannon.SC_H-32-5}}}}});var e=this;this.uiLayer.zankiLabel.setZanki(c),this.uiLayer.scoreLabel.set(a),this.uiLayer.rankLabel.set(b),this.mt=new MersenneTwister(1e3+this.stageIndex),this.scrollSpeed=cannon.STAGE_DATA[this.stageIndex].scrollSpeed,this.stageStep=cannon.STAGE_DATA[this.stageIndex].stageStep,this.waitCount=0,this.player=this.playerLayer.player,this.player.on("killed",function(){return c-=1,0>=c?void e.gameover():(b=Math.clamp(b-30,0,cannon.RANK_MAX),bulletml.Walker.globalScope.$rank=.001*b,e.uiLayer.rankLabel.add(-30),e.uiLayer.zankiLabel.setZanki(c),void e.tweener.clear().wait(500).call(function(){e.launchPlayer()}))}),bulletml.Walker.globalScope.$rank=.001*b,this.bulletmlConfig={target:this.player,createNewBullet:function(a,b){cannon.Bullet(a,b).addChildTo(this.bulletLayer),console.log("create new")}.bind(this)},this.launchPlayer()},update:function(a){var b=this,c=this.terrainLayer.children,d=this.backgroundLayer.children;c.forEach(function(a){a.scroll+=b.scrollSpeed}),d.forEach(function(a){a.scroll+=.5*b.scrollSpeed}),this.step(),this.testCollision(),a.keyboard.getKeyDown("space")&&this.app.pushScene(cannon.PauseScene())},step:function(){if(this.waitCount-=1,!(this.waitCount>0)){var a=this.stageStep.shift();if(void 0!==a)switch(a.type){case"wait":this.waitCount=a.value;break;case"enemy":this.launchEnemy(a)}}},launchEnemy:function(a){var b=cannon.Enemy(cannon.ENEMY_DATA[a.enemyType]).addChildTo(this.enemyLayer);switch(a.motionType){case"route":b.setRoute(a.data);break;case"sine":b.setSineWaveMotion(a.data);break;case"horizontal":b.setHorizontalMotion(a.data);break;case"homing":b.setHomingMotion(a.data,this.player)}var c=a.attack;if(c){var d=c.match("{(\\d)}");d&&(c=c.replace(d[0],this.mt.nextInt(~~d[1])),console.log(c));var e=cannon.ATTACK_DATA[c];e&&b.startAttack(e,this.bulletmlConfig)}},testCollision:function(){var c,d,e=this.player,f=this.terrainLayer.children,g=cannon.Bullet.ACTIVES.clone();d=cannon.Enemy.ACTIVES.clone(),c=cannon.Shot.ACTIVES.clone();for(var h=0,i=c.length;i>h;h++)for(var j=c[h],k=0,l=d.length;l>k;k++){var m=d[k];if(j.isHitElement(m)){if(!m.damage(cannon.SHOT_POWER)){j.damage();break}var n=Math.min(j.killCount,5),o=[1,2,4,8,16,32][n]*m.score;a+=o,this.uiLayer.scoreLabel.add(o),j.killEnemy(m,this.uiLayer),b=Math.clamp(b+n,0,cannon.RANK_MAX),bulletml.Walker.globalScope.$rank=.001*b,this.uiLayer.rankLabel.add(n)}}c=cannon.Shot.ACTIVES.clone();for(var h=0,p=c.length;p>h;h++){var j=c[h];f.some(function(a){return a.isHit(j)})&&j.damage()}if(e.parent){d=cannon.Enemy.ACTIVES.clone();for(var h=0,q=d.length;q>h;h++){var m=d[h];if(e.isHitElement(m)&&e.damage())break}for(var h=0,q=g.length;q>h;h++){var r=g[h];if(e.isHitElement(r)&&(r.damage(),e.damage()))break}f.some(function(a){return a.isHit(e)})&&e.damage()}},launchPlayer:function(){var a=this.player;a.parent||a.addChildTo(this.playerLayer),a.controllable=!1,a.muteki=!0,a.direction=1,a.x=cannon.SC_W*-.2,a.y=.5*cannon.SC_H,a.boostOn(),a.tweener.clear().to({x:.2*cannon.SC_W},2e3,"easeOutBack").call(function(){a.controllable=!0}).wait(2e3).call(function(){a.muteki=!1,a.boostOff()})},gameover:function(){console.log("gameover!"),this.app.stop()}}),cannon.GameScene.createLoadingScene=function(a){return cannon.LoadingScene({width:cannon.SC_W,height:cannon.SC_H,assets:cannon.STAGE_DATA[a].assets,nextScene:function(){return cannon.GameScene(a)}})}}(),tm.define("cannon.LoadingScene",{superClass:"tm.ui.LoadingScene",init:function(){this.superInit.apply(this,arguments),this.stage.draw=function(a){a.clear(0,0,cannon.SC_W,cannon.SC_H)}},_createHiyoko:function(a){var b=tm.display.Shape(84,84);b.x=tm.util.Random.randint(0,a.width),b.y=tm.util.Random.randint(0,a.height),b.canvas.setColorStyle("white","hsl(220, 80%, 80%").fillCircle(42,42,32),b.canvas.setColorStyle("white","black").fillCircle(27,27,2),b.canvas.setColorStyle("white","brown").fillRect(40,70,4,15).fillTriangle(0,40,11,35,11,45),b.dir=tm.geom.Vector2.random(0,360,4);var c=tm.geom.Rect(0,0,a.width,a.height);return c.padding(42),b.update=function(){this.position.add(this.dir),this.x<c.left?(this.x=c.left,this.dir.x*=-1):this.x>c.right&&(this.x=c.right,this.dir.x*=-1),this.y<c.top?(this.y=c.top,this.dir.y*=-1):this.y>c.bottom&&(this.y=c.bottom,this.dir.y*=-1),this.dir.x<0?(this.rotation-=7,this.scaleX=1):(this.rotation+=7,this.scaleX=-1)},b}}),tm.define("cannon.MenuDialog",{superClass:"tm.ui.MenuDialog",init:function(a,b,c,d){this.superInit({title:a,menu:b,menuDesctiptions:c,defaultIndex:d||0,showExit:!0,screenWidth:cannon.SC_W,screenHeight:cannon.SC_H,backgroundColor:"hsla(200, 80%, 5%, 0.9)",boxColor:"hsla(200, 80%, 10%, 0.9)",cursorColor:"hsla(200, 80%, 30%, 0.9)",okKey:"z",cancelKey:"x"}),this.on("enter",function(){cannon.playSe("extend")}),this.on("preselected",function(){cannon.playSe("extend")}),this.on("selected",function(){cannon.playSe("shot")}),this.on("canceled",function(){cannon.playSe("extend")})}}),tm.define("cannon.PauseScene",{superClass:"tm.app.Scene",init:function(){this.superInit()},update:function(a){var b=a.keyboard;b.getKeyDown("space")&&this.app.popScene()}}),tm.define("cannon.TitleScene",{superClass:"tm.app.Scene",init:function(){this.superInit(),this.setInteractive(!0),this.fromJSON({children:{pre:{type:"tm.display.Label",init:["jsstg 2014",36],x:.25*cannon.SC_W,y:cannon.SC_H*(1-1/Math.PHI)-80,shadowColor:"white",shadowBlur:10},title:{type:"tm.display.Label",init:["Deep Striker",96],x:.5*cannon.SC_W,y:cannon.SC_H*(1-1/Math.PHI),fillStyle:tm.graphics.LinearGradient(.5*-cannon.SC_W,-100,.5*cannon.SC_W,100).addColorStopList([{offset:.3,color:"hsl(220, 50%, 50%)"},{offset:.5,color:"hsl(220, 80%,100%)"},{offset:.7,color:"hsl(220, 50%, 50%)"}]).toStyle(),shadowColor:"white",shadowBlur:10},credit:{type:"tm.display.Label",init:["Copyright (c) 2014 daishi_hmr",24],x:.5*cannon.SC_W,y:.9*cannon.SC_H}}}),this.on("pointingend",function(){this.openMenu()})},update:function(a){(a.keyboard.getKeyUp("z")||a.keyboard.getKeyUp("x")||a.keyboard.getKeyUp("space"))&&this.openMenu()},openMenu:function(){var a=this;cannon.app.pushScene(cannon.MenuDialog("MENU",["game start","option"],["ゲームスタート","設定"]).on("selected",function(b){switch(b.value){case"game start":a.startGame()}}))},startGame:function(){cannon.app.replaceScene(cannon.GameScene.createLoadingScene(0))}}),tm.define("cannon.Background",{superClass:"tm.display.CanvasElement",init:function(){this.superInit();var a=this;Array.range(0,3).forEach(function(b){var c=tm.display.Sprite("test",cannon.SC_H,cannon.SC_H).setOrigin(0,0).setPosition(cannon.SC_H*b,0).addChildTo(a);c.index=b}),this.scroll=0},update:function(){var a=this.scroll,b=cannon.SC_H;this.children.forEach(function(c){c.x=-a%b+b*c.index})}}),tm.define("cannon.Bullet",{superClass:"tm.display.Sprite",init:function(a,b){this.superInit("bullet",16,16),this.setScale(2,.5),this.setFrameIndex(b.color||0),this.setBoundingType("circle"),this.radius=8,this.runner=a,this.setPosition(this.runner.x,this.runner.y),this.runner.onVanish=function(){this.parent&&this.remove()}.bind(this);var c=0,d=0;this.on("enterframe",function(){this.rotation=Math.atan2(this.y-d,this.x-c)*Math.RAD_TO_DEG,c=this.x,d=this.y}),this.on("added",function(){cannon.Bullet.ACTIVES.push(this)}),this.on("removed",function(){cannon.Bullet.ACTIVES.erase(this)})},update:function(){this.runner.update(),this.setPosition(this.runner.x,this.runner.y),(this.x+this.radius<0||cannon.SC_W<=this.x-this.radius||this.y+this.radius<0||cannon.SC_H<=this.y-this.radius)&&this.remove()},damage:function(){this.remove()}}),cannon.Bullet.ACTIVES=[],tm.define("cannon.EffectSprite",{superClass:"tm.display.Sprite",init:function(a,b,c,d,e){this.superInit(a,b,c),this.setFrameIndex(0).setBlendMode("lighter"),this.f=0,this.finalIndex=d,this.frameIncr=e},update:function(){this.f+=this.frameIncr,this.frameIndex=~~this.f,this.f>=this.finalIndex&&this.remove()}}),tm.define("cannon.Explode",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("explode0",128,128,64,1),this.setRotation(Math.rand(0,360)).setScale(2).setPosition(a,b)},onadded:function(){cannon.playSe("explode0")}}),tm.define("cannon.LargeExplode",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("explode1",128,128,64,1),this.setRotation(Math.rand(0,360)).setScale(3.5).setPosition(a,b)},onadded:function(){cannon.playSe("explode1")}}),tm.define("cannon.PlayerExplode",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("explodeBlue",64,64,64,1),this.setRotation(Math.rand(0,360)).setScale(2.5).setPosition(a,b)},onadded:function(){cannon.playSe("explode1")}}),tm.define("cannon.ShockWave",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("shockwave",64,64,64,2),this.setPosition(a,b)}}),tm.define("cannon.Spark",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("spark",64,64,64,2),this.setPosition(a,b)}}),tm.define("cannon.Spark2",{superClass:"cannon.EffectSprite",init:function(a,b,c){this.superInit("spark2",128,128,25,c||1.5),this.setOrigin(.9,.5).setPosition(a,b)}}),tm.define("cannon.Boost",{superClass:"cannon.EffectSprite",init:function(a,b){this.superInit("boost",128,128,25,1),this.setPosition(a,b)}}),tm.define("cannon.Enemy",{superClass:"tm.display.Sprite",score:0,hp:0,muteki:0,entered:!1,expType:0,age:0,init:function(a){if(this.superInit(a.texture,2*a.size,2*a.size),this.setFrameIndex(0).setBoundingType("circle").setBlendMode("lighter"),this.size=a.size,this.radius=.5*a.size,this.score=a.score,this.hp=a.hp,this.expType=a.expType,this.age=0,"rotate"===a.rotation)this.on("enterframe",function(){this.rotation+=6});else if("direction"===a.rotation){var b=0,c=0;this.on("enterframe",function(){this.rotation=Math.atan2(this.y-c,this.x-b)*Math.RAD_TO_DEG,b=this.x,c=this.y})}else this.rotation=0,this.scaleX=-1;this.on("added",function(){cannon.Enemy.ACTIVES.push(this),this.entered=!1,this.age=0}),this.on("removed",function(){cannon.Enemy.ACTIVES.erase(this)})},setRoute:function(a){this.setPosition(a[0].x,a[0].y);for(var b=this.tweener.clear(),c=0,d=a.length;d>c;c++)b.to(a[c],100);return this},setSineWaveMotion:function(a){this.setPosition(a.x,a.y);var b=a.ia;this.on("enterframe",function(){b+=a.va,this.x+=a.vx,this.y=a.y+Math.sin(b)*a.r})},setHorizontalMotion:function(a){this.setPosition(a.x,a.y),this.on("enterframe",function(){this.x+=a.vx})},setHomingMotion:function(a,b){this.setPosition(a.x,a.y),this.velocity=tm.geom.Vector2().setAngle(a.initialDirection,1),this.on("enterframe",function(){this.age<500&&this.age%100<20&&this.age%2===0&&this.velocity.add(tm.geom.Vector2(b.x-this.x,b.y-this.y).mul(a.homing)).normalize(),this.position.add(tm.geom.Vector2.mul(this.velocity,a.speed))})},update:function(a){this.muteki=Math.max(0,this.muteki-1),this.setFrameIndex(this.muteki>0?a.frame%2:0),this.inScreen()&&(this.entered=!0),!this.inScreen()&&this.entered&&this.remove(),this.age+=1},inScreen:function(){return 0<=this.x+this.size&&this.x-this.size<cannon.SC_W&&0<=this.y+this.size&&this.size-this.size<cannon.SC_H},damage:function(a){if(this.muteki<=0&&(this.hp-=a,this.muteki=10,this.hp<=0)){switch(this.expType){case 0:cannon.Explode(this.x,this.y).addChildTo(this.parent);break;case 1:cannon.LargeExplode(this.x,this.y).addChildTo(this.parent)}return this.remove(),!0}return!1},startAttack:function(a,b){b=(b||{}).$safe(bulletml.runner.DEFAULT_CONFIG);var c=a.createRunner(b);c.x=this.x,c.y=this.y;var d=function(){c.x=this.x,c.y=this.y,c.update(),this.setPosition(c.x,c.y)};d.isDanmaku=!0,this.on("enterframe",d)},stopAttack:function(){if(this.hasEventListener("enterframe"))for(var a=this._listeners.enterframe.clone(),b=0;b<a.length;b++)a[b].isDanmaku&&this.off("enterframe",a[b])}}),cannon.Enemy.ACTIVES=[],tm.define("cannon.Fighter",{superClass:"tm.display.CanvasElement",scene:null,controllable:!1,muteki:!1,direction:1,init:function(){this.superInit(),this.fromJSON({children:{backfire2:{type:"tm.display.Sprite",init:"backfire",originX:1,blendMode:"lighter"},backfire:{type:"tm.display.Sprite",init:["aura",80,120],frameIndex:0,x:-50,y:0,blendMode:"lighter"},body:{type:"tm.display.Sprite",init:["fighter",128,64],frameIndex:2,scaleX:.75,scaleY:.75}}}),this.setBoundingType("circle"),this.radius=cannon.FIGHTER_RADIUS,this.beforeX=this.x=cannon.SC_W*-.5,this.beforeY=this.y=.5*cannon.SC_H,this.roll=0,this.heat=0,this.gunPosition=0,this.backfire.update=function(a){this.visible&&(this.setFrameIndex(a.frame%4),this.scaleX=[.8,1,1.2,1][a.frame%4])},this.backfire2.update=function(a){this.visible&&(this.scaleX=[.8,1,1.2,1][a.frame%4])}},update:function(a){if(this.scaleX=this.direction,this.controllable){var b=a.keyboard,c=b.getKeyDirection();this.position.add(c.mul(cannon.FIGHTER_SPEED)),this.x=Math.clamp(this.x,32,cannon.SC_W-32),this.y=Math.clamp(this.y,16,cannon.SC_H-16),c.y<0?this.roll-=.1:0<c.y?this.roll+=.1:(this.roll*=.9,-.01<this.roll&&this.roll<.01&&(this.roll=0));var d=b.getKeyDown("z"),e=b.getKeyDown("x");(d||e)&&(this.direction=e?1:-1,this.heat<=0&&(cannon.Shot(this.direction).setPosition(this.x+60*this.direction,this.y+7).addChildTo(this.parent),this.heat=cannon.HEAT_BY_SHOT,this.gunPosition=2),this.scaleX!==this.direction&&cannon.Boost(this.x,this.y).setPosition(-100,0).setScale(2,2).addChildTo(this)),this.heat>0&&(this.heat-=1,this.gunPosition=Math.max(this.gunPosition-.2,0),this.heat<=0&&cannon.playSe("reload"))}else this.roll*=.9,-.01<this.roll&&this.roll<.01&&(this.roll=0);this.roll=Math.clamp(this.roll,-2,2),this.body.setFrameIndex(3*~~(2+this.roll+.5)+~~(this.gunPosition+.5))},boostOn:function(){this.backfire.alpha=this.backfire2.alpha=1,this.backfire.visible=this.backfire2.visible=!0},boostOff:function(){this.backfire.tweener.clear().fadeOut(300),this.backfire2.tweener.clear().fadeOut(300).call(function(){this.backfire.visible=this.backfire2.visible=!1}.bind(this))},damage:function(){return this.controllable&&!this.muteki?(cannon.PlayerExplode(this.x,this.y).addChildTo(this.parent),this.remove(),this.flare("killed"),!0):!1}}),tm.define("cannon.RankLabel",{superClass:"tm.display.Label",rank:0,showing:0,init:function(){this.superInit("0",60),this.setAlign("left").setBaseline("top").setFillStyle("white").setFontFamily("UFL")},add:function(a){this.rank=Math.clamp(this.rank+a,0,cannon.RANK_MAX),this.tweener.clear().to({showing:this.rank},500)},set:function(a){this.rank=a,this.showing=a},update:function(a){var b="rank:"+Math.floor(this.showing);this.text!==b&&(this.text=b),this.alpha=.6+.4*Math.sin(.1*a.frame)}}),tm.define("cannon.ScoreLabel",{superClass:"tm.display.Label",score:0,showing:0,init:function(){this.superInit("0",60),this.setAlign("right").setBaseline("top").setFillStyle("white").setFontFamily("UFL")},add:function(a){this.score+=a,this.tweener.clear().to({showing:this.score},500)},set:function(a){this.score=a,this.showing=a},update:function(a){var b="score:"+Math.floor(this.showing);this.text!==b&&(this.text=b),this.alpha=.6+.4*Math.sin(.1*a.frame)}}),tm.define("cannon.ScoreRate",{superClass:"tm.display.Sprite",init:function(a,b,c){this.superInit("scorerate",64,64),this.setScale(2).setPosition(b,c).setFrameIndex(a),this.tweener.to({y:c-120,alpha:0},1e3).call(function(){this.remove()}.bind(this))}}),tm.define("cannon.Shot",{superClass:"tm.display.Sprite",direction:1,killCount:0,init:function(a){this.superInit("shot"),this.direction=a,this.setScale(5*this.direction,5),this.boundingType="circle",this.radius=cannon.SHOT_RADIUS;var b=this;this.on("added",function(){cannon.playSe("shot"),cannon.ShockWave(this.x,this.y).setScale(1*this.direction,4).on("enterframe",function(){this.x+=2*-b.direction}).addChildTo(this.parent),cannon.Spark(this.x,this.y).setRotation(Math.rand(0,360)).setScale(2*this.direction,2).addChildTo(this.parent),cannon.Spark2(this.x,this.y,3).setScale(2*this.direction,1).addChildTo(this.parent)}),this.on("added",function(){cannon.Shot.ACTIVES.push(this)}),this.on("removed",function(){cannon.Shot.ACTIVES.erase(this)})},update:function(a){this.scaleY=5+a.frame%2,this.x+=cannon.SHOT_SPEED*this.direction,(this.x<0-this.radius||cannon.SC_W+this.radius<this.x)&&this.remove()},killEnemy:function(a,b){this.killCount>0&&cannon.ScoreRate(Math.min(this.killCount-1,4),a.x,a.y).addChildTo(b),this.killCount+=1},damage:function(){cannon.ShockWave(this.x,this.y).setScale(1*this.direction,4).addChildTo(this.parent),cannon.ShockWave(this.x,this.y).setScale(.75*this.direction,3).addChildTo(this.parent),cannon.Spark2(this.x,this.y).setScale(3*this.direction,3).addChildTo(this.parent),this.remove()}}),cannon.Shot.ACTIVES=[],tm.define("cannon.Terrain",{superClass:"tm.display.CanvasElement",init:function(a){this.superInit(),this.setOrigin(0,0),this.lines=[];for(var b=0,c=a.lines.length;c>b;b++)this.lines.push({a:tm.geom.Vector2(a.lines[b][0],a.lines[b][1]),b:tm.geom.Vector2(a.lines[b][2],a.lines[b][3])});this.scroll=0,this.strokeStyle="hsl(30, 80%, 80%)";var d=this;this.s=tm.display.Sprite(a.texture,8e3,640).setOrigin(0,0).setPosition(0,0).addChildTo(this).on("enterframe",function(){this.x=-d.scroll})},isHit:function(a){for(var b={x:a.x+this.scroll,y:a.y,radius:a.radius},c=this.lines,d=this.scroll,e=0,f=c.length;f>e;e++){var g=c[e],h=g.a,i=g.b;if((0<=h.x-d&&h.x-d<cannon.SC_W||0<=i.x-d&&i.x-d<cannon.SC_W)&&cannon.CollisionHelper.isHitCircleLine(b,g))return!0}return!1}}),tm.define("cannon.ZankiLabel",{superClass:"tm.display.CanvasElement",init:function(){this.superInit(),this.fromJSON({children:Array.range(0,cannon.ZANKI_MAX).map(function(a){return{type:"tm.display.CanvasElement",x:64*a,children:[{type:"tm.display.RoundRectangleShape",init:[51.2,51.2,{fillStyle:"rgba(255, 255, 255, 0.1)",strokeStyle:"transparent"}],blendMode:"lighter"},{type:"tm.display.Sprite",init:["fighter",128,64],scaleX:.4,scaleY:.4,frameIndex:6,blendMode:"lighter"}]}})}),this.setZanki(0)},setZanki:function(a){this.children.forEach(function(b,c){b.visible=a-1>c})}}),tm.geom=tm.geom||{},function(){tm.define("tm.geom.Bezier",{vertices:null,init:function(a,b){b=b||10,this.vertices=[];for(var c=0;b>=c;c++){var d=tm.geom.Bezier.getPointOnCurve(a,c/b);this.vertices.push([d[0],d[1]])}}}),tm.geom.Bezier.getPointOnCurve=function(a,b){for(;a.length>1;){for(var c=[],d=0,e=a.length-1;e>d;d++)c[d]=[a[d][0]+(a[d+1][0]-a[d][0])*b,a[d][1]+(a[d+1][1]-a[d][1])*b];a=c}return a[0]}}(),cannon.CollisionHelper={isHitCircleLine:function(a,b){var c=tm.geom.Vector2,d=b.s||(b.s=c.sub(b.b,b.a)),e=c.sub(a,b.a),f=c.sub(a,b.b),g=a.radius*a.radius;return e.lengthSquared()<=g||f.lengthSquared()<=g?!0:Math.abs(c.cross(d,e))/d.length()>a.radius?!1:c.dot(e,d)*c.dot(f,d)<=0}},cannon.spline=function(a,b){for(var c=new Spline({points:a,duration:b}),d=[],e=0;b>e;e++)d.push(c.pos(e));return d},function(){function a(){this.r=0,this.g=0,this.b=0,this.a=0,this.next=null}tm.graphics.Canvas.prototype.stackBlur=function(d){var e=this.width,f=this.height,g=(this.canvas,this.context);if(!(isNaN(d)||1>d)){d|=0;var h;try{try{h=g.getImageData(0,0,e,f)}catch(i){try{netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead"),h=g.getImageData(0,0,e,f)}catch(i){throw alert("Cannot access local image"),new Error("unable to access local image data: "+i)}}}catch(i){throw alert("Cannot access image"),new Error("unable to access image data: "+i)}var j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H=h.data,I=d+d+1,J=e-1,K=f-1,L=d+1,M=L*(L+1)/2,N=new a,O=N;for(l=1;I>l;l++)if(O=O.next=new a,l==L)var P=O;O.next=N;var Q=null,R=null;p=o=0;var S=b[d],T=c[d];for(k=0;f>k;k++){for(y=z=A=B=q=r=s=t=0,u=L*(C=H[o]),v=L*(D=H[o+1]),w=L*(E=H[o+2]),x=L*(F=H[o+3]),q+=M*C,r+=M*D,s+=M*E,t+=M*F,O=N,l=0;L>l;l++)O.r=C,O.g=D,O.b=E,O.a=F,O=O.next;for(l=1;L>l;l++)m=o+((l>J?J:l)<<2),q+=(O.r=C=H[m])*(G=L-l),r+=(O.g=D=H[m+1])*G,s+=(O.b=E=H[m+2])*G,t+=(O.a=F=H[m+3])*G,y+=C,z+=D,A+=E,B+=F,O=O.next;for(Q=N,R=P,j=0;e>j;j++)H[o+3]=F=t*S>>T,0!=F?(F=255/F,H[o]=(q*S>>T)*F,H[o+1]=(r*S>>T)*F,H[o+2]=(s*S>>T)*F):H[o]=H[o+1]=H[o+2]=0,q-=u,r-=v,s-=w,t-=x,u-=Q.r,v-=Q.g,w-=Q.b,x-=Q.a,m=p+((m=j+d+1)<J?m:J)<<2,y+=Q.r=H[m],z+=Q.g=H[m+1],A+=Q.b=H[m+2],B+=Q.a=H[m+3],q+=y,r+=z,s+=A,t+=B,Q=Q.next,u+=C=R.r,v+=D=R.g,w+=E=R.b,x+=F=R.a,y-=C,z-=D,A-=E,B-=F,R=R.next,o+=4;p+=e}for(j=0;e>j;j++){for(z=A=B=y=r=s=t=q=0,o=j<<2,u=L*(C=H[o]),v=L*(D=H[o+1]),w=L*(E=H[o+2]),x=L*(F=H[o+3]),q+=M*C,r+=M*D,s+=M*E,t+=M*F,O=N,l=0;L>l;l++)O.r=C,O.g=D,O.b=E,O.a=F,O=O.next;for(n=e,l=1;d>=l;l++)o=n+j<<2,q+=(O.r=C=H[o])*(G=L-l),r+=(O.g=D=H[o+1])*G,s+=(O.b=E=H[o+2])*G,t+=(O.a=F=H[o+3])*G,y+=C,z+=D,A+=E,B+=F,O=O.next,K>l&&(n+=e);for(o=j,Q=N,R=P,k=0;f>k;k++)m=o<<2,H[m+3]=F=t*S>>T,F>0?(F=255/F,H[m]=(q*S>>T)*F,H[m+1]=(r*S>>T)*F,H[m+2]=(s*S>>T)*F):H[m]=H[m+1]=H[m+2]=0,q-=u,r-=v,s-=w,t-=x,u-=Q.r,v-=Q.g,w-=Q.b,x-=Q.a,m=j+((m=k+L)<K?m:K)*e<<2,q+=y+=Q.r=H[m],r+=z+=Q.g=H[m+1],s+=A+=Q.b=H[m+2],t+=B+=Q.a=H[m+3],Q=Q.next,u+=C=R.r,v+=D=R.g,w+=E=R.b,x+=F=R.a,y-=C,z-=D,A-=E,B-=F,R=R.next,o+=e}return g.putImageData(h,0,0),this}};var b=[512,512,456,512,328,456,335,512,405,328,271,456,388,335,292,512,454,405,364,328,298,271,496,456,420,388,360,335,312,292,273,512,482,454,428,405,383,364,345,328,312,298,284,271,259,496,475,456,437,420,404,388,374,360,347,335,323,312,302,292,282,273,265,512,497,482,468,454,441,428,417,405,394,383,373,364,354,345,337,328,320,312,305,298,291,284,278,271,265,259,507,496,485,475,465,456,446,437,428,420,412,404,396,388,381,374,367,360,354,347,341,335,329,323,318,312,307,302,297,292,287,282,278,273,269,265,261,512,505,497,489,482,475,468,461,454,447,441,435,428,422,417,411,405,399,394,389,383,378,373,368,364,359,354,350,345,341,337,332,328,324,320,316,312,309,305,301,298,294,291,287,284,281,278,274,271,268,265,262,259,257,507,501,496,491,485,480,475,470,465,460,456,451,446,442,437,433,428,424,420,416,412,408,404,400,396,392,388,385,381,377,374,370,367,363,360,357,354,350,347,344,341,338,335,332,329,326,323,320,318,315,312,310,307,304,302,299,297,294,292,289,287,285,282,280,278,275,273,271,269,267,265,263,261,259],c=[9,11,12,13,13,14,14,15,15,15,15,16,16,16,16,17,17,17,17,17,17,17,18,18,18,18,18,18,18,18,18,19,19,19,19,19,19,19,19,19,19,19,19,19,19,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,20,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,21,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,22,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,23,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24,24]}(),tm.main(function(){cannon.app=cannon.Application("#main"),cannon.app.fps=60,cannon.app.resize(cannon.SC_W,cannon.SC_H).fitWindow().replaceScene(cannon.LoadingScene({width:cannon.SC_W,height:cannon.SC_H,assets:cannon.ASSETS,nextScene:cannon.onAssetsLoaded(cannon.TitleScene)})),"localhost"===location.hostname&&(tm.util.Script.loadStats().onload=function(){cannon.app.enableStats()});var a=document.createElement("span");a.style.fontFamily="'OFL', 'monospace'",a.innerHTML="QW@HhsXJ",document.body.appendChild(a);var b=a.offsetWidth,c=20,d=function(){c-=1,a.offsetWidth!==b||0>c?(document.body.removeChild(a),cannon.app.run()):setTimeout(d,100)};d()}),cannon.ATTACK_DATA={},function(){for(var a=bulletml.dsl.action,b=(bulletml.dsl.actionRef,bulletml.dsl.bullet),c=(bulletml.dsl.bulletRef,bulletml.dsl.fire),d=(bulletml.dsl.fireRef,bulletml.dsl.changeDirection,bulletml.dsl.changeSpeed,bulletml.dsl.accel,bulletml.dsl.wait),e=(bulletml.dsl.vanish,bulletml.dsl.repeat),f=(bulletml.dsl.bindVar,bulletml.dsl.notify,bulletml.dsl.direction),g=bulletml.dsl.speed,h=(bulletml.dsl.horizontal,bulletml.dsl.vertical,bulletml.dsl.fireOption,bulletml.dsl.offsetX,bulletml.dsl.offsetY),i=(bulletml.dsl.autonomy,function(a){return g("{0} * 3 * (1 + Math.sqrt($rank) * 2)".format(a))}),j=function(a){return d("{0} / (1 + Math.sqrt($rank))".format(a))},k=0;5>k;k++)cannon.ATTACK_DATA["simple{0}".format(k)]=new bulletml.Root({top:a([j(220+20*k),e(999,[c(i(1),b()),j(120)])])});cannon.ATTACK_DATA.horizontal2=new bulletml.Root({top:a([e(999,[j(130),e(6,[c(f(-90,"absolute"),i(1.5),b({color:1}),h(-20)),c(f(-90,"absolute"),i(1.5),b({color:1}),h(20)),d(3)])])])})}(),cannon.ENEMY_DATA=[{texture:"enemy0",size:128,score:500,hp:8,expType:1,rotation:"fix"},{texture:"enemy1",size:64,score:100,hp:1,expType:0,rotation:"fix"},{texture:"enemy2",size:64,score:100,hp:1,expType:0,rotation:"fix"},{texture:"enemy3",size:64,score:100,hp:1,expType:0,rotation:"direction"},{texture:"enemy4",size:128,score:500,hp:8,expType:1,rotation:"fix"},{texture:"enemy5",size:128,score:500,hp:8,expType:1,rotation:"fix"},{texture:"enemy6",size:64,score:100,hp:1,expType:0,rotation:"fix"},{texture:"enemy7",size:64,score:100,hp:1,expType:0,rotation:"rotate"},{texture:"enemy8",size:64,score:100,hp:1,expType:0,rotation:"rotate"},{texture:"enemy9",size:64,score:100,hp:1,expType:0,rotation:"rotate"},{texture:"enemy10",size:64,score:100,hp:1,expType:0,rotation:"rotate"},{texture:"enemy11",size:64,score:100,hp:1,expType:0,rotation:"rotate"},{texture:"enemy12",size:64,score:100,hp:1,expType:0,rotation:"rotate"},{texture:"enemy13",size:64,score:100,hp:1,expType:0,rotation:"rotate"},{texture:"enemy14",size:64,score:100,hp:1,expType:0,rotation:"rotate"}],cannon.STAGE_DATA=[],function(){var a=function(a){return{type:"wait",value:a}},b=function(a,b,c){return{type:"enemy",attack:"simple{5}",enemyType:3,motionType:"homing",data:{x:a,y:b,initialDirection:c,speed:3,homing:.001}}},c=function(a){return{type:"enemy",attack:"horizontal2",enemyType:5,motionType:"horizontal",data:{x:1060,y:a,vx:-1.4}}},d=function(a){var b;switch(a){case 0:b=cannon.spline([{x:320,y:-100},{x:100,y:320},{x:320,y:540},{x:760,y:540},{x:860,y:320},{x:480,y:320},{x:-100,y:320}],100);break;case 1:b=cannon.spline([{x:640,y:-100},{x:860,y:320},{x:640,y:540},{x:200,y:540},{x:100,y:320},{x:480,y:320},{x:1060,y:320}],100)}return{type:"enemy",attack:"simple{5}",enemyType:7,motionType:"route",data:b}},e=function(a){var b;switch(a){case 0:b=cannon.spline([{x:900,y:-100},{x:900,y:600},{x:600,y:270},{x:-200,y:270}],60);break;case 1:b=cannon.spline([{x:900,y:760},{x:900,y:40},{x:600,y:370},{x:-200,y:370}],60);break;case 2:b=cannon.spline([{x:900,y:-100},{x:900,y:600},{x:600,y:315},{x:-200,y:315}],60);break;case 3:b=cannon.spline([{x:900,y:760},{x:900,y:40},{x:600,y:325},{x:-200,y:325}],60);break;case 4:b=cannon.spline([{x:60,y:-100},{x:60,y:600},{x:360,y:270},{x:1160,y:270}],60);break;case 5:b=cannon.spline([{x:60,y:760},{x:60,y:40},{x:360,y:370},{x:1160,y:370}],60)}return{type:"enemy",attack:"simple{5}",enemyType:8,motionType:"route",data:b}},f=function(a,b,c){return{type:"enemy",attack:"simple{5}",enemyType:10,motionType:"sine",data:{x:a,y:b,vx:-2,ia:Math.PI*c,va:.04,r:120}}};cannon.STAGE_DATA[0]={assets:{stage1:"genasset/stage1_half.png",test:"genasset/test.png"},terrain:{texture:"stage1",lines:[[383,-12,434,1],[433,-1,520,4],[520,4,656,-1],[656,-1,815,6],[815,6,986,-2],[1356,-6,1471,60],[1471,60,1496,59],[1496,59,1558,19],[1558,19,1661,-8],[1810,-8,1845,39],[1845,39,1885,14],[1885,14,1887,-12],[2180,-4,2209,13],[2209,13,2257,10],[2257,10,2271,16],[2271,16,2313,20],[2313,20,2337,12],[2337,12,2419,22],[2419,22,2447,31],[2447,31,2463,42],[2463,42,2553,43],[2552,43,2596,44],[2596,44,2633,36],[2633,36,2786,41],[2786,41,2847,43],[2847,43,2934,39],[2934,39,2997,42],[2997,42,3060,33],[3060,34,3242,25],[3241,23,3324,30],[3324,29,3392,18],[3392,18,3496,33],[3496,33,3554,34],[3554,34,3626,60],[3626,60,3678,75],[3674,73,3756,42],[3756,42,3912,23],[3912,23,4018,33],[4018,33,4102,39],[4102,39,4186,79],[4186,79,4242,87],[4238,89,4337,62],[4337,61,4442,56],[4442,56,4580,38],[4579,35,4612,43],[4612,43,4867,29],[4867,29,4880,23],[4880,23,5117,44],[5116,43,5245,27],[5245,27,5470,47],[5470,47,5558,31],[5558,31,5713,39],[5713,39,5742,33],[5742,33,5939,53],[5939,50,6166,61],[6166,61,6277,58],[6277,58,6426,54],[6426,53,6495,43],[6495,43,6648,55],[6648,55,6777,97],[6775,96,6902,160],[6902,161,6953,121],[6953,121,7058,57],[7058,57,7239,-6],[1848,665,1860,630],[1860,630,1936,632],[1934,630,1956,627],[1956,627,2058,623],[2058,623,2102,615],[2102,615,2188,609],[2188,609,2370,608],[2370,609,2607,622],[2607,622,2818,627],[2822,627,2909,611],[2909,610,3140,630],[3137,630,3232,615],[3232,615,3428,633],[3428,633,3766,614],[3765,614,3792,620],[3791,620,3943,602],[3942,602,4006,606],[4005,606,4138,567],[4137,564,4147,573],[4147,573,4204,580],[4203,579,4257,610],[4257,610,4428,634],[4430,633,4545,627],[4549,627,4611,619],[4611,619,4703,584],[4706,582,4802,618],[4802,618,4974,635],[4973,635,5057,630],[5056,629,5131,633],[5131,633,5339,623],[5338,623,5531,614],[5539,612,5585,615],[5589,617,5710,619],[5711,619,5818,611],[5818,611,5916,606],[5912,607,5928,615],[5927,615,5990,626],[5990,626,6158,624],[6158,624,6164,610],[6164,610,6203,630],[6203,630,6331,633],[6331,633,6356,626],[6356,626,6366,641],[6366,641,6470,621],[6470,621,6525,563],[6526,563,6536,563],[6536,563,6571,601],[6574,601,6630,618],[6638,619,6704,604],[6704,604,6824,550],[6824,550,6880,510],[6878,509,6917,513],[6915,512,7008,570],[7008,570,7109,611],[7109,611,7135,608],[7135,608,7170,630],[7170,630,7211,626],[7211,626,7305,641],[7305,641,7333,633],[7333,633,7394,657]]},scrollSpeed:1,stageStep:[a(100),a(100),e(0),a(10),e(0),a(10),e(0),a(10),e(0),a(10),e(0),a(150),e(1),a(10),e(1),a(10),e(1),a(10),e(1),a(10),e(1),a(150),e(0),a(10),e(0),a(10),e(0),a(10),e(0),a(10),e(0),a(150),e(1),a(10),e(1),a(10),e(1),a(10),e(1),a(10),e(1),a(250),e(2),e(3),a(10),e(2),e(3),a(10),e(2),e(3),a(10),e(2),e(3),a(10),e(2),e(3),a(200),f(1060,270,0),f(1160,270,1),f(1260,270,0),f(1360,270,1),a(200),f(1060,370,0),f(1160,370,1),f(1260,370,0),f(1360,370,1),a(250),c(320),a(100),c(290),a(120),c(260),a(80),c(240),a(250),b(-100,128,90),b(-100,256,90),b(-100,384,90),b(-100,512,90),a(150),e(1),a(10),e(1),a(10),e(1),a(10),e(1),a(10),e(1),a(150),e(4),a(10),e(4),a(10),e(4),a(10),e(4),a(10),e(4),a(150),e(5),a(10),e(5),a(10),e(5),a(10),e(5),a(10),e(5),a(250),b(-100,128,90),b(-100,256,90),b(-100,384,90),b(-100,512,90),b(1060,128,-90),b(1060,256,-90),b(1060,384,-90),b(1060,512,-90),a(150),d(1),a(15),d(1),a(15),d(1),a(15),d(1),a(15),d(1),a(15),a(150),d(0),a(15),d(0),a(15),d(0),a(15),d(0),a(15),d(0),a(15),a(250),e(0),a(10),e(0),a(10),e(0),a(10),e(0),a(10),e(0),a(250),e(5),a(10),e(5),a(10),e(5),a(10),e(5),a(10),e(5),a(250),e(1),e(5),a(10),e(1),e(5),a(10),e(1),e(5),a(10),e(1),e(5),a(10),e(1),e(5)]}
}();
//# sourceMappingURL=cannon-stg.min.js.map